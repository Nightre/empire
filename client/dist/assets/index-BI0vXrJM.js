var e=Object.defineProperty,t=(t,r,n)=>((t,r,n)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n)(t,"symbol"!=typeof r?r+"":r,n);import{c as r,g as n,r as s}from"./phaser-BS73_o1m.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const r of e)if("childList"===r.type)for(const e of r.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var i,o={},a={},c=function(e,t){return(c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}c(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var h=function(){return h=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var s in t=arguments[r])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e},h.apply(this,arguments)};function u(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(r[n[s]]=e[n[s]])}return r}function d(e,t,r,n){var s,i=arguments.length,o=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,r,o):s(t,r))||o);return i>3&&o&&Object.defineProperty(t,r,o),o}function f(e,t){return function(r,n){t(r,n,e)}}function p(e,t,r,n,s,i){function o(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var a,c=n.kind,l="getter"===c?"get":"setter"===c?"set":"value",h=!t&&e?n.static?e:e.prototype:null,u=t||(h?Object.getOwnPropertyDescriptor(h,n.name):{}),d=!1,f=r.length-1;f>=0;f--){var p={};for(var g in n)p[g]="access"===g?{}:n[g];for(var g in n.access)p.access[g]=n.access[g];p.addInitializer=function(e){if(d)throw new TypeError("Cannot add initializers after decoration has completed");i.push(o(e||null))};var m=(0,r[f])("accessor"===c?{get:u.get,set:u.set}:u[l],p);if("accessor"===c){if(void 0===m)continue;if(null===m||"object"!=typeof m)throw new TypeError("Object expected");(a=o(m.get))&&(u.get=a),(a=o(m.set))&&(u.set=a),(a=o(m.init))&&s.unshift(a)}else(a=o(m))&&("field"===c?s.unshift(a):u[l]=a)}h&&Object.defineProperty(h,n.name,u),d=!0}function g(e,t,r){for(var n=arguments.length>2,s=0;s<t.length;s++)r=n?t[s].call(e,r):t[s].call(e);return n?r:void 0}function m(e){return"symbol"==typeof e?e:"".concat(e)}function y(e,t,r){return"symbol"==typeof t&&(t=t.description?"[".concat(t.description,"]"):""),Object.defineProperty(e,"name",{configurable:!0,value:r?"".concat(r," ",t):t})}function v(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function b(e,t,r,n){return new(r||(r=Promise))(function(s,i){function o(e){try{c(n.next(e))}catch(t){i(t)}}function a(e){try{c(n.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,a)}c((n=n.apply(e,t||[])).next())})}function w(e,t){var r,n,s,i={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=a(0),o.throw=a(1),o.return=a(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(c){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(i=0)),i;)try{if(r=1,n&&(s=2&a[0]?n.return:a[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,a[1])).done)return s;switch(n=0,s&&(a=[2&a[0],s.value]),a[0]){case 0:case 1:s=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,n=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((s=(s=i.trys).length>0&&s[s.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!s||a[1]>s[0]&&a[1]<s[3])){i.label=a[1];break}if(6===a[0]&&i.label<s[1]){i.label=s[1],s=a;break}if(s&&i.label<s[2]){i.label=s[2],i.ops.push(a);break}s[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(c){a=[6,c],n=0}finally{r=s=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}var E=Object.create?function(e,t,r,n){void 0===n&&(n=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,s)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]};function O(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||E(t,e,r)}function I(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function A(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,s,i=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(a){s={error:a}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(s)throw s.error}}return o}function T(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(A(arguments[t]));return e}function S(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var n=Array(e),s=0;for(t=0;t<r;t++)for(var i=arguments[t],o=0,a=i.length;o<a;o++,s++)n[s]=i[o];return n}function _(e,t,r){if(r||2===arguments.length)for(var n,s=0,i=t.length;s<i;s++)!n&&s in t||(n||(n=Array.prototype.slice.call(t,0,s)),n[s]=t[s]);return e.concat(n||Array.prototype.slice.call(t))}function x(e){return this instanceof x?(this.v=e,this):new x(e)}function C(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,s=r.apply(e,t||[]),i=[];return n=Object.create(("function"==typeof AsyncIterator?AsyncIterator:Object).prototype),o("next"),o("throw"),o("return",function(e){return function(t){return Promise.resolve(t).then(e,l)}}),n[Symbol.asyncIterator]=function(){return this},n;function o(e,t){s[e]&&(n[e]=function(t){return new Promise(function(r,n){i.push([e,t,r,n])>1||a(e,t)})},t&&(n[e]=t(n[e])))}function a(e,t){try{(r=s[e](t)).value instanceof x?Promise.resolve(r.value.v).then(c,l):h(i[0][2],r)}catch(n){h(i[0][3],n)}var r}function c(e){a("next",e)}function l(e){a("throw",e)}function h(e,t){e(t),i.shift(),i.length&&a(i[0][0],i[0][1])}}function P(e){var t,r;return t={},n("next"),n("throw",function(e){throw e}),n("return"),t[Symbol.iterator]=function(){return this},t;function n(n,s){t[n]=e[n]?function(t){return(r=!r)?{value:x(e[n](t)),done:!1}:s?s(t):t}:s}}function R(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e=I(e),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(r){t[r]=e[r]&&function(t){return new Promise(function(n,s){!function(e,t,r,n){Promise.resolve(n).then(function(t){e({value:t,done:r})},t)}(n,s,(t=e[r](t)).done,t.value)})}}}function k(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var D=Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t},N=function(e){return(N=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t})(e)};function $(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=N(e),n=0;n<r.length;n++)"default"!==r[n]&&E(t,e,r[n]);return D(t,e),t}function M(e){return e&&e.__esModule?e:{default:e}}function j(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)}function L(e,t,r,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,r):s?s.value=r:t.set(e,r),r}function B(e,t){if(null===t||"object"!=typeof t&&"function"!=typeof t)throw new TypeError("Cannot use 'in' operator on non-object");return"function"==typeof e?t===e:e.has(t)}function F(e,t,r){if(null!=t){if("object"!=typeof t&&"function"!=typeof t)throw new TypeError("Object expected.");var n,s;if(r){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");n=t[Symbol.asyncDispose]}if(void 0===n){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");n=t[Symbol.dispose],r&&(s=n)}if("function"!=typeof n)throw new TypeError("Object not disposable.");s&&(n=function(){try{s.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:n,async:r})}else r&&e.stack.push({async:!0});return t}var U="function"==typeof SuppressedError?SuppressedError:function(e,t,r){var n=new Error(r);return n.name="SuppressedError",n.error=e,n.suppressed=t,n};function V(e){function t(t){e.error=e.hasError?new U(t,e.error,"An error was suppressed during disposal."):t,e.hasError=!0}var r,n=0;return function s(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(s);if(r.dispose){var i=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(i).then(s,function(e){return t(e),s()})}else n|=1}catch(o){t(o)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()}function z(e,t){return"string"==typeof e&&/^\.\.?\//.test(e)?e.replace(/\.(tsx)$|((?:\.d)?)((?:\.[^./]+?)?)\.([cm]?)ts$/i,function(e,r,n,s,i){return r?t?".jsx":".js":!n||s&&i?n+s+"."+i.toLowerCase()+"js":e}):e}const W={__extends:l,__assign:h,__rest:u,__decorate:d,__param:f,__esDecorate:p,__runInitializers:g,__propKey:m,__setFunctionName:y,__metadata:v,__awaiter:b,__generator:w,__createBinding:E,__exportStar:O,__values:I,__read:A,__spread:T,__spreadArrays:S,__spreadArray:_,__await:x,__asyncGenerator:C,__asyncDelegator:P,__asyncValues:R,__makeTemplateObject:k,__importStar:$,__importDefault:M,__classPrivateFieldGet:j,__classPrivateFieldSet:L,__classPrivateFieldIn:B,__addDisposableResource:F,__disposeResources:V,__rewriteRelativeImportExtension:z},H=n(Object.freeze(Object.defineProperty({__proto__:null,__addDisposableResource:F,get __assign(){return h},__asyncDelegator:P,__asyncGenerator:C,__asyncValues:R,__await:x,__awaiter:b,__classPrivateFieldGet:j,__classPrivateFieldIn:B,__classPrivateFieldSet:L,__createBinding:E,__decorate:d,__disposeResources:V,__esDecorate:p,__exportStar:O,__extends:l,__generator:w,__importDefault:M,__importStar:$,__makeTemplateObject:k,__metadata:v,__param:f,__propKey:m,__read:A,__rest:u,__rewriteRelativeImportExtension:z,__runInitializers:g,__setFunctionName:y,__spread:T,__spreadArray:_,__spreadArrays:S,__values:I,default:W},Symbol.toStringTag,{value:"Module"})));var q,J={};function K(){return q||(q=1,function(e){var t;e.CloseCode=void 0,(t=e.CloseCode||(e.CloseCode={}))[t.CONSENTED=4e3]="CONSENTED",t[t.DEVMODE_RESTART=4010]="DEVMODE_RESTART";class r extends Error{constructor(e,t){super(t),this.name="ServerError",this.code=e}}class n extends Error{constructor(e){super(e),this.name="AbortError"}}e.AbortError=n,e.ServerError=r}(J)),J}var Y,G,X={},Z={},Q={},ee={exports:{}};function te(){return Y||(Y=1,function(e){const t=255;var r;e.OPERATION=void 0,(r=e.OPERATION||(e.OPERATION={}))[r.ADD=128]="ADD",r[r.REPLACE=0]="REPLACE",r[r.DELETE=64]="DELETE",r[r.DELETE_AND_MOVE=96]="DELETE_AND_MOVE",r[r.MOVE_AND_ADD=160]="MOVE_AND_ADD",r[r.DELETE_AND_ADD=192]="DELETE_AND_ADD",r[r.CLEAR=10]="CLEAR",r[r.REVERSE=15]="REVERSE",r[r.MOVE=32]="MOVE",r[r.DELETE_BY_REFID=33]="DELETE_BY_REFID",r[r.ADD_BY_REFID=129]="ADD_BY_REFID",Symbol.metadata??(Symbol.metadata=Symbol.for("Symbol.metadata"));const n="~track",s="~encoder",i="~decoder",o="~filter",a="~getByIndex",c="~deleteByIndex",l="~changes",h="~childType",u="~onEncodeEnd",d="~onDecodeEnd",f="~descriptors",p="~__numFields",g="~__refTypeFieldIndexes",m="~__viewFieldIndexes",y="$__fieldIndexesByViewTag";let v;try{v=new TextEncoder}catch(st){}const b=new ArrayBuffer(8),w=new Int32Array(b),E=new Float32Array(b),O=new Float64Array(b),I=new BigInt64Array(b),A="undefined"!=typeof Buffer&&Buffer.byteLength?Buffer.byteLength:function(e,t){for(var r=0,n=0,s=0,i=e.length;s<i;s++)(r=e.charCodeAt(s))<128?n+=1:r<2048?n+=2:r<55296||r>=57344?n+=3:(s++,n+=4);return n};function T(e,t,r){for(var n=0,s=0,i=t.length;s<i;s++)(n=t.charCodeAt(s))<128?e[r.offset++]=n:n<2048?(e[r.offset]=192|n>>6,e[r.offset+1]=128|63&n,r.offset+=2):n<55296||n>=57344?(e[r.offset]=224|n>>12,e[r.offset+1]=128|n>>6&63,e[r.offset+2]=128|63&n,r.offset+=3):(s++,n=65536+((1023&n)<<10|1023&t.charCodeAt(s)),e[r.offset]=240|n>>18,e[r.offset+1]=128|n>>12&63,e[r.offset+2]=128|n>>6&63,e[r.offset+3]=128|63&n,r.offset+=4)}function S(e,t,r){e[r.offset++]=255&t}function _(e,t,r){e[r.offset++]=255&t,e[r.offset++]=t>>8&255}function x(e,t,r){e[r.offset++]=255&t,e[r.offset++]=t>>8&255}function C(e,t,r){e[r.offset++]=255&t,e[r.offset++]=t>>8&255,e[r.offset++]=t>>16&255,e[r.offset++]=t>>24&255}function P(e,t,r){const n=t>>24,s=t>>16,i=t>>8,o=t;e[r.offset++]=255&o,e[r.offset++]=255&i,e[r.offset++]=255&s,e[r.offset++]=255&n}function R(e,t,r){const n=Math.floor(t/Math.pow(2,32));P(e,t>>>0,r),P(e,n,r)}function k(e,t,r){const n=t/Math.pow(2,32)|0;P(e,t>>>0,r),P(e,n,r)}function D(e,t,r){E[0]=t,C(e,w[0],r)}function N(e,t,r){O[0]=t,C(e,w[0],r),C(e,w[1],r)}const $={int8:S,uint8:function(e,t,r){e[r.offset++]=255&t},int16:_,uint16:x,int32:C,uint32:P,int64:R,uint64:k,bigint64:function(e,t,r){I[0]=BigInt.asIntN(64,t),C(e,w[0],r),C(e,w[1],r)},biguint64:function(e,t,r){I[0]=BigInt.asIntN(64,t),C(e,w[0],r),C(e,w[1],r)},float32:D,float64:N,boolean:function(e,t,r){e[r.offset++]=t?1:0},string:function(e,t,r){t||(t="");let n=A(t,"utf8"),s=0;if(n<32)e[r.offset++]=160|n,s=1;else if(n<256)e[r.offset++]=217,e[r.offset++]=n%255,s=2;else if(n<65536)e[r.offset++]=218,x(e,n,r),s=3;else{if(!(n<4294967296))throw new Error("String too long");e[r.offset++]=219,P(e,n,r),s=5}return T(e,t,r),s+n},number:function e(t,r,n){return isNaN(r)?e(t,0,n):isFinite(r)?r!==(0|r)?Math.abs(r)<=34028235e31&&(E[0]=r,Math.abs(Math.abs(E[0])-Math.abs(r))<1e-4)?(t[n.offset++]=202,D(t,r,n),5):(t[n.offset++]=203,N(t,r,n),9):r>=0?r<128?(t[n.offset++]=255&r,1):r<256?(t[n.offset++]=204,t[n.offset++]=255&r,2):r<65536?(t[n.offset++]=205,x(t,r,n),3):r<4294967296?(t[n.offset++]=206,P(t,r,n),5):(t[n.offset++]=207,k(t,r,n),9):r>=-32?(t[n.offset++]=224|r+32,1):r>=-128?(t[n.offset++]=208,S(t,r,n),2):r>=-32768?(t[n.offset++]=209,_(t,r,n),3):r>=-2147483648?(t[n.offset++]=210,C(t,r,n),5):(t[n.offset++]=211,R(t,r,n),9):e(t,r>0?Number.MAX_SAFE_INTEGER:-Number.MAX_SAFE_INTEGER,n)},utf8Write:T,utf8Length:A},M=new ArrayBuffer(8),j=new Int32Array(M),L=new Float32Array(M),B=new Float64Array(M),F=new BigUint64Array(M),U=new BigInt64Array(M);function V(e,t,r){for(var n="",s=0,i=t.offset,o=t.offset+r;i<o;i++){var a=e[i];128&a?192!=(224&a)?224!=(240&a)?240!=(248&a)?console.error("Invalid byte "+a.toString(16)):(s=(7&a)<<18|(63&e[++i])<<12|(63&e[++i])<<6|63&e[++i])>=65536?(s-=65536,n+=String.fromCharCode((s>>>10)+55296,56320+(1023&s))):n+=String.fromCharCode(s):n+=String.fromCharCode((15&a)<<12|(63&e[++i])<<6|63&e[++i]):n+=String.fromCharCode((31&a)<<6|63&e[++i]):n+=String.fromCharCode(a)}return t.offset+=r,n}function z(e,t){return W(e,t)<<24>>24}function W(e,t){return e[t.offset++]}function H(e,t){return q(e,t)<<16>>16}function q(e,t){return e[t.offset++]|e[t.offset++]<<8}function J(e,t){return e[t.offset++]|e[t.offset++]<<8|e[t.offset++]<<16|e[t.offset++]<<24}function K(e,t){return J(e,t)>>>0}function Y(e,t){return j[0]=J(e,t),L[0]}function G(e,t){return j[0]=J(e,t),j[1]=J(e,t),B[0]}function X(e,t){const r=K(e,t);return J(e,t)*Math.pow(2,32)+r}function Z(e,t){const r=K(e,t);return K(e,t)*Math.pow(2,32)+r}const Q={utf8Read:V,int8:z,uint8:W,int16:H,uint16:q,int32:J,uint32:K,float32:Y,float64:G,int64:X,uint64:Z,bigint64:function(e,t){return j[0]=J(e,t),j[1]=J(e,t),U[0]},biguint64:function(e,t){return j[0]=J(e,t),j[1]=J(e,t),F[0]},boolean:function(e,t){return W(e,t)>0},string:function(e,t){const r=e[t.offset++];let n;return r<192?n=31&r:217===r?n=W(e,t):218===r?n=q(e,t):219===r&&(n=K(e,t)),V(e,t,n)},number:function(e,t){const r=e[t.offset++];return r<128?r:202===r?Y(e,t):203===r?G(e,t):204===r?W(e,t):205===r?q(e,t):206===r?K(e,t):207===r?Z(e,t):208===r?z(e,t):209===r?H(e,t):210===r?J(e,t):211===r?X(e,t):r>223?-1*(255-r+1):void 0},stringCheck:function(e,t){const r=e[t.offset];return r<192&&r>160||217===r||218===r||219===r}},ee={},te=new Map;function re(e,t){t.constructor&&(te.set(t.constructor,e),ee[e]=t),t.encode&&($[e]=t.encode),t.decode&&(Q[e]=t.decode)}function ne(e){return ee[e]}const se=class e{static register(t){const r=Object.getPrototypeOf(t);if(r!==qe){let n=e.inheritedTypes.get(r);n||(n=new Set,e.inheritedTypes.set(r,n)),n.add(t)}}static cache(t){let r=e.cachedContexts.get(t);return r||(r=new e(t),e.cachedContexts.set(t,r)),r}constructor(e){this.types={},this.schemas=new Map,this.hasFilters=!1,this.parentFiltered={},e&&this.discoverTypes(e)}has(e){return this.schemas.has(e)}get(e){return this.types[e]}add(e,t=this.schemas.size){return!this.schemas.has(e)&&(this.types[t]=e,void 0===e[Symbol.metadata]&&ae.initialize(e),this.schemas.set(e,t),!0)}getTypeId(e){return this.schemas.get(e)}discoverTypes(t,r,n,s){var i,o;if(s&&this.registerFilteredByParent(t,r,n),!this.add(t))return;null==(i=e.inheritedTypes.get(t))||i.forEach(e=>{this.discoverTypes(e,r,n,s)});let a=t;for(;(a=Object.getPrototypeOf(a))&&a!==qe&&a!==Function.prototype;)this.discoverTypes(a);const c=t[o=Symbol.metadata]??(t[o]={});c[m]&&(this.hasFilters=!0);for(const e in c){const r=e,n=c[r].type,i=void 0!==c[r].tag;if("string"!=typeof n)if("function"==typeof n)this.discoverTypes(n,t,r,s||i);else{const e=Object.values(n)[0];if("string"==typeof e)continue;this.discoverTypes(e,t,r,s||i)}}}registerFilteredByParent(e,t,r){let n=`${this.schemas.get(e)??this.schemas.size}`;t&&(n+=`-${this.schemas.get(t)}`),n+=`-${r}`,this.parentFiltered[n]=!0}debug(){let e="";for(const t in this.parentFiltered){const r=t.split("-").map(Number),n=r.pop();e+="\n\t\t",e+=`${t}: ${r.reverse().map((e,t)=>{const r=this.types[e],s=r[Symbol.metadata];let i=r.name;return 0===t&&(i+=`[${s[n].name}]`),`${i}`}).join(" -> ")}`}return`TypeContext ->\n\tSchema types: ${this.schemas.size}\n\thasFilters: ${this.hasFilters}\n\tparentFiltered:${e}`}};se.inheritedTypes=new Map,se.cachedContexts=new Map;let ie=se;function oe(e){if(Array.isArray(e))return{array:oe(e[0])};if(void 0!==e.type)return e.type;if(function(e){if("function"==typeof e&&e[Symbol.metadata])return!1;const t=Object.keys(e),r=t.filter(e=>/\d+/.test(e));return r.length>0&&r.length===t.length/2&&e[e[r[0]]]==r[0]||!!(t.length>0&&t.every(t=>"string"==typeof e[t]&&e[t]===t))}(e))return Object.keys(e).every(t=>"string"==typeof e[t])?"string":"number";if("object"==typeof e&&null!==e){const t=Object.keys(e).find(e=>void 0!==ee[e]);if(t)return e[t]=oe(e[t]),e}return e}const ae={addField(e,t,r,n,s){if(t>64)throw new Error(`Can't define field '${r}'.\nSchema instances may only have up to 64 fields.`);e[t]=Object.assign(e[t]||{},{type:oe(n),index:t,name:r}),Object.defineProperty(e,f,{value:e[f]||{},enumerable:!1,configurable:!0}),s?(e[f][r]=s,e[f][`_${r}`]={value:void 0,writable:!0,enumerable:!1,configurable:!0}):e[f][r]={value:void 0,writable:!0,enumerable:!0,configurable:!0},Object.defineProperty(e,p,{value:t,enumerable:!1,configurable:!0}),Object.defineProperty(e,r,{value:t,enumerable:!1,configurable:!0}),"string"!=typeof e[t].type&&(void 0===e[g]&&Object.defineProperty(e,g,{value:[],enumerable:!1,configurable:!0}),e[g].push(t))},setTag(e,t,r){const n=e[t];e[n].tag=r,e[m]||(Object.defineProperty(e,m,{value:[],enumerable:!1,configurable:!0}),Object.defineProperty(e,y,{value:{},enumerable:!1,configurable:!0})),e[m].push(n),e[y][r]||(e[y][r]=[]),e[y][r].push(n)},setFields(e,t){const r=e.prototype.constructor;ie.register(r);const o=Object.getPrototypeOf(r),a=o&&o[Symbol.metadata],c=ae.initialize(r);r[n]||(r[n]=qe[n]),r[s]||(r[s]=qe[s]),r[i]||(r[i]=qe[i]),r.prototype.toJSON||(r.prototype.toJSON=qe.prototype.toJSON);let l=c[p]??(a&&a[p])??-1;l++;for(const n in t){const e=oe(t[n]),r="string"==typeof Object.keys(e)[0]&&ne(Object.keys(e)[0]),s=r?Object.values(e)[0]:e;ae.addField(c,l,n,e,Ue(`_${n}`,l,s,r)),l++}return e},isDeprecated:(e,t)=>!0===e[t].deprecated,init(e){const t={};e[Symbol.metadata]=t,Object.defineProperty(t,p,{value:0,enumerable:!1,configurable:!0})},initialize(e){const t=Object.getPrototypeOf(e),r=t[Symbol.metadata];let n=e[Symbol.metadata]??Object.create(null);return t!==qe&&n===r&&(n=Object.create(null),r&&(Object.setPrototypeOf(n,r),Object.defineProperty(n,p,{value:r[p],enumerable:!1,configurable:!0,writable:!0}),void 0!==r[m]&&(Object.defineProperty(n,m,{value:[...r[m]],enumerable:!1,configurable:!0,writable:!0}),Object.defineProperty(n,y,{value:{...r[y]},enumerable:!1,configurable:!0,writable:!0})),void 0!==r[g]&&Object.defineProperty(n,g,{value:[...r[g]],enumerable:!1,configurable:!0,writable:!0}),Object.defineProperty(n,f,{value:{...r[f]},enumerable:!1,configurable:!0,writable:!0}))),e[Symbol.metadata]=n,n},isValidInstance:e=>e.constructor[Symbol.metadata]&&Object.prototype.hasOwnProperty.call(e.constructor[Symbol.metadata],p),getFields(e){const t=e[Symbol.metadata],r={};for(let n=0;n<=t[p];n++)r[t[n].name]=t[n].type;return r},hasViewTagAtIndex(e,t){var r;return null==(r=null==e?void 0:e[m])?void 0:r.includes(t)}};function ce(e){return{indexes:{},operations:[],queueRootNode:e}}function le(e,t){const r=e.indexes[t];void 0===r?e.indexes[t]=e.operations.push(t)-1:e.operations[r]=t}function he(e,t){var r;let n=e.indexes[t];void 0===n&&(n=Object.values(e.indexes).at(-1),t=null==(r=Object.entries(e.indexes).find(([e,t])=>t===n))?void 0:r[0]),e.operations[n]=void 0,delete e.indexes[t]}class ue{constructor(e){var t;this.isFiltered=!1,this.indexedOperations={},this.changes={indexes:{},operations:[]},this.allChanges={indexes:{},operations:[]},this.isNew=!0,this.ref=e,this.metadata=e.constructor[Symbol.metadata],(null==(t=this.metadata)?void 0:t[m])&&(this.allFilteredChanges={indexes:{},operations:[]},this.filteredChanges={indexes:{},operations:[]})}setRoot(e){this.root=e;const t=this.root.add(this);this.checkIsFiltered(this.parent,this.parentIndex,t),t&&this.forEachChild((t,r)=>{t.root!==e?t.setRoot(e):e.add(t)})}setParent(e,t,r){if(this.addParent(e,r),!t)return;const n=t.add(this);t!==this.root&&(this.root=t,this.checkIsFiltered(e,r,n)),n&&this.forEachChild((e,r)=>{if(e.root===t)return t.add(e),void t.moveNextToParent(e);e.setParent(this.ref,t,r)})}forEachChild(e){var t,r;if(this.ref[h]){if("string"!=typeof this.ref[h])for(const[n,s]of this.ref.entries())e(s[l],(null==(t=this.indexes)?void 0:t[n])??n)}else for(const n of(null==(r=this.metadata)?void 0:r[g])??[]){const t=this.metadata[n],r=this.ref[t.name];r&&e(r[l],n)}}operation(e){var t,r;void 0!==this.filteredChanges?(this.filteredChanges.operations.push(-e),null==(t=this.root)||t.enqueueChangeTree(this,"filteredChanges")):(this.changes.operations.push(-e),null==(r=this.root)||r.enqueueChangeTree(this,"changes"))}change(t,r=e.OPERATION.ADD){var n,s,i;const o=this.isFiltered||void 0!==(null==(s=null==(n=this.metadata)?void 0:n[t])?void 0:s.tag),a=o?this.filteredChanges:this.changes,c=this.indexedOperations[t];if(!c||c===e.OPERATION.DELETE){const n=c&&c===e.OPERATION.DELETE?e.OPERATION.DELETE_AND_ADD:r;this.indexedOperations[t]=n}le(a,t),o?(le(this.allFilteredChanges,t),this.root&&(this.root.enqueueChangeTree(this,"filteredChanges"),this.root.enqueueChangeTree(this,"allFilteredChanges"))):(le(this.allChanges,t),null==(i=this.root)||i.enqueueChangeTree(this,"changes"))}shiftChangeIndexes(e){const t=this.isFiltered?this.filteredChanges:this.changes,r={},n={};for(const s in this.indexedOperations)r[Number(s)+e]=this.indexedOperations[s],n[Number(s)+e]=t.indexes[s];this.indexedOperations=r,t.indexes=n,t.operations=t.operations.map(t=>t+e)}shiftAllChangeIndexes(e,t=0){void 0!==this.filteredChanges?(this._shiftAllChangeIndexes(e,t,this.allFilteredChanges),this._shiftAllChangeIndexes(e,t,this.allChanges)):this._shiftAllChangeIndexes(e,t,this.allChanges)}_shiftAllChangeIndexes(e,t=0,r){const n={};let s=0;for(const i in r.indexes)n[s++]=r.indexes[i];r.indexes=n;for(let i=0;i<r.operations.length;i++){const n=r.operations[i];n>t&&(r.operations[i]=n+e)}}indexedOperation(e,t,r=e){var n,s;this.indexedOperations[e]=t,void 0!==this.filteredChanges?(le(this.allFilteredChanges,r),le(this.filteredChanges,e),null==(n=this.root)||n.enqueueChangeTree(this,"filteredChanges")):(le(this.allChanges,r),le(this.changes,e),null==(s=this.root)||s.enqueueChangeTree(this,"changes"))}getType(e){return this.ref[h]||this.metadata[e].type}getChange(e){return this.indexedOperations[e]}getValue(e,t=!1){return this.ref[a](e,t)}delete(t,r,n=t){var s,i,o;if(void 0===t){try{throw new Error(`@colyseus/schema ${this.ref.constructor.name}: trying to delete non-existing index '${t}'`)}catch(st){console.warn(st)}return}const a=void 0!==this.filteredChanges?this.filteredChanges:this.changes;this.indexedOperations[t]=r??e.OPERATION.DELETE,le(a,t),he(this.allChanges,n);const c=this.getValue(t);return c&&c[l]&&(null==(s=this.root)||s.remove(c[l])),void 0!==this.filteredChanges?(he(this.allFilteredChanges,n),null==(i=this.root)||i.enqueueChangeTree(this,"filteredChanges")):null==(o=this.root)||o.enqueueChangeTree(this,"changes"),c}endEncode(e){var t,r;this.indexedOperations={},this[e]=ce(),null==(r=(t=this.ref)[u])||r.call(t),this.isNew=!1}discard(e=!1){var t,r;null==(r=(t=this.ref)[u])||r.call(t),this.indexedOperations={},this.changes=ce(this.changes.queueRootNode),void 0!==this.filteredChanges&&(this.filteredChanges=ce(this.filteredChanges.queueRootNode)),e&&(this.allChanges=ce(this.allChanges.queueRootNode),void 0!==this.allFilteredChanges&&(this.allFilteredChanges=ce(this.allFilteredChanges.queueRootNode)))}discardAll(){const e=Object.keys(this.indexedOperations);for(let t=0,r=e.length;t<r;t++){const r=this.getValue(Number(e[t]));r&&r[l]&&r[l].discardAll()}this.discard()}get changed(){return Object.entries(this.indexedOperations).length>0}checkIsFiltered(e,t,r){var n,s,i,o;this.root.types.hasFilters&&(this._checkFilteredByParent(e,t),void 0!==this.filteredChanges&&(null==(n=this.root)||n.enqueueChangeTree(this,"filteredChanges"),r&&(null==(s=this.root)||s.enqueueChangeTree(this,"allFilteredChanges")))),this.isFiltered||(null==(i=this.root)||i.enqueueChangeTree(this,"changes"),r&&(null==(o=this.root)||o.enqueueChangeTree(this,"allChanges")))}_checkFilteredByParent(e,t){if(!e)return;const r=ae.isValidInstance(this.ref)?this.ref.constructor:this.ref[h];let n,s=!ae.isValidInstance(e);s?(n=e[l],e=n.parent,t=n.parentIndex):n=e[l];const i=e.constructor;let o=`${this.root.types.getTypeId(r)}`;i&&(o+=`-${this.root.types.schemas.get(i)}`),o+=`-${t}`;const a=ae.hasViewTagAtIndex(null==i?void 0:i[Symbol.metadata],t);this.isFiltered=e[l].isFiltered||this.root.types.parentFiltered[o]||a,this.isFiltered&&(this.isVisibilitySharedWithParent=n.isFiltered&&"string"!=typeof r&&!a&&s,this.filteredChanges||(this.filteredChanges=ce(),this.allFilteredChanges=ce()),this.changes.operations.length>0&&(this.changes.operations.forEach(e=>le(this.filteredChanges,e)),this.allChanges.operations.forEach(e=>le(this.allFilteredChanges,e)),this.changes=ce(),this.allChanges=ce()))}get parent(){var e;return null==(e=this.parentChain)?void 0:e.ref}get parentIndex(){var e;return null==(e=this.parentChain)?void 0:e.index}addParent(e,t){this.hasParent((t,r)=>t[l]===e[l])?this.parentChain.index=t:this.parentChain={ref:e,index:t,next:this.parentChain}}removeParent(e=this.parent){let t=this.parentChain,r=null;for(;t;){if(t.ref[l]===e[l])return r?r.next=t.next:this.parentChain=t.next,!0;r=t,t=t.next}return void 0===this.parentChain}findParent(e){let t=this.parentChain;for(;t;){if(e(t.ref,t.index))return t;t=t.next}}hasParent(e){return void 0!==this.findParent(e)}getAllParents(){const e=[];let t=this.parentChain;for(;t;)e.push({ref:t.ref,index:t.index}),t=t.next;return e}}function de(t,r,n,s,i,o){var a;"string"==typeof n?null==(a=$[n])||a.call($,r,s,o):void 0!==n[Symbol.metadata]?($.number(r,s[l].refId,o),(i&e.OPERATION.ADD)===e.OPERATION.ADD&&t.tryEncodeTypeId(r,n,s.constructor,o)):$.number(r,s[l].refId,o)}const fe=function(t,r,n,s,i,o,a,c,l){if(r[o.offset++]=255&(s|i),i===e.OPERATION.DELETE)return;const h=n.ref,u=l[s];de(t,r,l[s].type,h[u.name],i,o)},pe=function(t,r,n,s,i,o){if(r[o.offset++]=255&i,$.number(r,s,o),i===e.OPERATION.DELETE)return;const c=n.ref;if((i&e.OPERATION.ADD)===e.OPERATION.ADD&&"function"==typeof c.set){const e=n.ref.$indexes.get(s);$.string(r,e,o)}de(t,r,c[h],c[a](s),i,o)},ge=function(t,r,n,s,i,o,a,c){const h=n.ref;let u;if(c&&n.isFiltered&&"string"!=typeof n.getType(s)){const t=h.tmpItems[s];if(!t)return;u=t[l].refId,i===e.OPERATION.DELETE?i=e.OPERATION.DELETE_BY_REFID:i===e.OPERATION.ADD&&(i=e.OPERATION.ADD_BY_REFID)}else u=s;r[o.offset++]=255&i,$.number(r,u,o),i!==e.OPERATION.DELETE&&i!==e.OPERATION.DELETE_BY_REFID&&de(t,r,n.getType(s),n.getValue(s,a),i,o)};function me(t,r,n,s,i,o,l,u){const d=t.root,f=n[a](s);let p;if((r&e.OPERATION.DELETE)===e.OPERATION.DELETE){const t=d.refIds.get(f);void 0!==t&&d.removeRef(t),r!==e.OPERATION.DELETE_AND_ADD&&n[c](s),p=void 0}if(r===e.OPERATION.DELETE);else if(qe.is(i)){const n=Q.number(o,l);if(p=d.refs.get(n),(r&e.OPERATION.ADD)===e.OPERATION.ADD){const s=t.getInstanceType(o,l,i);p||(p=t.createInstanceOfType(s)),d.addRef(n,p,p!==f||r===e.OPERATION.DELETE_AND_ADD&&p===f)}}else if("string"==typeof i)p=Q[i](o,l);else{const t=ne(Object.keys(i)[0]),n=Q.number(o,l),s=d.refs.has(n)?f||d.refs.get(n):new t.constructor;if(p=s.clone(!0),p[h]=Object.values(i)[0],f){let t=d.refIds.get(f);if(void 0!==t&&n!==t){const r=f.entries();let n;for(;(n=r.next())&&!n.done;){const[r,s]=n.value;"object"==typeof s&&(t=d.refIds.get(s),d.removeRef(t)),u.push({ref:f,refId:t,op:e.OPERATION.DELETE,field:r,value:void 0,previousValue:s})}}}d.addRef(n,p,s!==f||r===e.OPERATION.DELETE_AND_ADD&&s===f)}return{value:p,previousValue:f}}const ye=function(e,t,r,n,s){const i=t[r.offset++],o=n.constructor[Symbol.metadata],a=i>>6<<6,c=i%(a||255),l=o[c];if(void 0===l)return console.warn("@colyseus/schema: field not defined at",{index:c,ref:n.constructor.name,metadata:o}),-1;const{value:h,previousValue:u}=me(e,a,n,c,l.type,t,r,s);null!=h&&(n[l.name]=h),u!==h&&s.push({ref:n,refId:e.currentRefId,op:a,field:l.name,value:h,previousValue:u})},ve=function(t,r,n,s,i){const o=r[n.offset++];if(o===e.OPERATION.CLEAR)return t.removeChildRefs(s,i),void s.clear();const a=Q.number(r,n),c=s[h];let l;(o&e.OPERATION.ADD)===e.OPERATION.ADD?"function"==typeof s.set?(l=Q.string(r,n),s.setIndex(a,l)):l=a:l=s.getIndex(a);const{value:u,previousValue:d}=me(t,o,s,a,c,r,n,i);if(null!=u)if("function"==typeof s.set)s.$items.set(l,u);else if("function"==typeof s.$setAt)s.$setAt(a,u,o);else if("function"==typeof s.add){const e=s.add(u);"number"==typeof e&&s.setIndex(e,e)}d!==u&&i.push({ref:s,refId:t.currentRefId,op:o,field:"",dynamicIndex:l,value:u,previousValue:d})};class be extends Error{}function we(e,t,r,n){if(!(e instanceof t))throw new be(`a '${t.name}' was expected, but '${e&&e.constructor.name}' was provided in ${r.constructor.name}#${n}`)}var Ee,Oe;const Ie=(e,t)=>{const r=e.toString(),n=t.toString();return r<n?-1:r>n?1:0},Ae=class t{static[(Ee=s,Oe=i,o)](e,t,r){var n;return!r||"string"==typeof e[h]||r.isChangeTreeVisible(null==(n=e.tmpItems[t])?void 0:n[l])}static is(e){return Array.isArray(e)||void 0!==e.array}static from(e){return new t(...Array.from(e))}constructor(...t){this.items=[],this.tmpItems=[],this.deletedIndexes={},this.isMovingItems=!1,Object.defineProperty(this,h,{value:void 0,enumerable:!1,writable:!0,configurable:!0});const r=new Proxy(this,{get:(e,t)=>"symbol"==typeof t||isNaN(t)?Reflect.get(e,t):this.items[t],set:(t,r,n)=>{var s;if("symbol"==typeof r||isNaN(r))return Reflect.set(t,r,n);if(null==n)t.$deleteAt(r);else{if(n[l]){we(n,t[h],t,r);const i=t.items[r];t.isMovingItems?(void 0!==i?n[l].isNew?t[l].indexedOperation(Number(r),e.OPERATION.MOVE_AND_ADD):(t[l].getChange(Number(r))&e.OPERATION.DELETE)===e.OPERATION.DELETE?t[l].indexedOperation(Number(r),e.OPERATION.DELETE_AND_MOVE):t[l].indexedOperation(Number(r),e.OPERATION.MOVE):n[l].isNew&&t[l].indexedOperation(Number(r),e.OPERATION.ADD),n[l].setParent(this,t[l].root,r)):t.$changeAt(Number(r),n),void 0!==i&&(null==(s=i[l].root)||s.remove(i[l]))}else t.$changeAt(Number(r),n);t.items[r]=n,t.tmpItems[r]=n}return!0},deleteProperty:(e,t)=>("number"==typeof t?e.$deleteAt(t):delete e[t],!0),has:(e,t)=>"symbol"==typeof t||isNaN(Number(t))?Reflect.has(e,t):Reflect.has(this.items,t)});return Object.defineProperty(this,l,{value:new ue(r),enumerable:!1,writable:!0}),t.length>0&&this.push(...t),r}set length(e){0===e?this.clear():e<this.items.length?this.splice(e,this.length-e):console.warn("ArraySchema: can't set .length to a higher value than its length.")}get length(){return this.items.length}push(...t){var r;let n=this.tmpItems.length;const s=this[l];for(let i=0,o=t.length;i<o;i++,n++){const o=t[i];if(null==o)return;"object"==typeof o&&this[h]&&we(o,this[h],this,i),s.indexedOperation(n,e.OPERATION.ADD,this.items.length),this.items.push(o),this.tmpItems.push(o),null==(r=o[l])||r.setParent(this,s.root,n)}return n}pop(){let e=-1;for(let t=this.tmpItems.length-1;t>=0;t--)if(!0!==this.deletedIndexes[t]){e=t;break}if(!(e<0))return this[l].delete(e,void 0,this.items.length-1),this.deletedIndexes[e]=!0,this.items.pop()}at(e){return e<0&&(e+=this.length),this.items[e]}$changeAt(t,r){var n;if(null==r)return void console.error("ArraySchema items cannot be null nor undefined; Use `deleteAt(index)` instead.");if(this.items[t]===r)return;const s=void 0!==this.items[t]?"object"==typeof r?e.OPERATION.DELETE_AND_ADD:e.OPERATION.REPLACE:e.OPERATION.ADD,i=this[l];i.change(t,s),null==(n=r[l])||n.setParent(this,i.root,t)}$deleteAt(e,t){this[l].delete(e,t)}$setAt(t,r,n){0===t&&n===e.OPERATION.ADD&&void 0!==this.items[t]?this.items.unshift(r):n===e.OPERATION.DELETE_AND_MOVE?(this.items.splice(t,1),this.items[t]=r):this.items[t]=r}clear(){if(0===this.items.length)return;const t=this[l];t.forEachChild((e,r)=>{var n;null==(n=t.root)||n.remove(e)}),t.discard(!0),t.operation(e.OPERATION.CLEAR),this.items.length=0,this.tmpItems.length=0}concat(...e){return new t(...this.items.concat(...e))}join(e){return this.items.join(e)}reverse(){return this[l].operation(e.OPERATION.REVERSE),this.items.reverse(),this.tmpItems.reverse(),this}shift(){if(0===this.items.length)return;const t=this[l],r=this.tmpItems.findIndex(e=>e===this.items[0]),n=this.items.findIndex(e=>e===this.items[0]);return t.delete(r,e.OPERATION.DELETE,n),t.shiftAllChangeIndexes(-1,n),this.deletedIndexes[r]=!0,this.items.shift()}slice(e,r){const n=new t;return n.push(...this.items.slice(e,r)),n}sort(t=Ie){this.isMovingItems=!0;const r=this[l];return this.items.sort(t).forEach((t,n)=>r.change(n,e.OPERATION.REPLACE)),this.tmpItems.sort(t),this.isMovingItems=!1,this}splice(t,r,...n){var s,i,o;const a=this[l],c=this.items.length,h=this.tmpItems.length,u=n.length,d=[];for(let e=0;e<h;e++)!0!==this.deletedIndexes[e]&&d.push(e);if(c>t){void 0===r&&(r=c-t);for(let n=t;n<t+r;n++){const t=d[n];a.delete(t,e.OPERATION.DELETE),this.deletedIndexes[t]=!0}}else r=0;if(u>0){if(u>r)throw console.error("Inserting more elements than deleting during ArraySchema#splice()"),new Error("ArraySchema#splice(): insertCount must be equal or lower than deleteCount.");for(let r=0;r<u;r++){const i=(d[t]??c)+r;a.indexedOperation(i,this.deletedIndexes[i]?e.OPERATION.DELETE_AND_ADD:e.OPERATION.ADD),null==(s=n[r][l])||s.setParent(this,a.root,i)}}return r>u&&a.shiftAllChangeIndexes(-(r-u),d[t+u]),void 0!==a.filteredChanges?null==(i=a.root)||i.enqueueChangeTree(a,"filteredChanges"):null==(o=a.root)||o.enqueueChangeTree(a,"changes"),this.items.splice(t,r,...n)}unshift(...t){const r=this[l];return r.shiftChangeIndexes(t.length),r.isFiltered?le(r.filteredChanges,this.items.length):le(r.allChanges,this.items.length),t.forEach((t,n)=>{r.change(n,e.OPERATION.ADD)}),this.tmpItems.unshift(...t),this.items.unshift(...t)}indexOf(e,t){return this.items.indexOf(e,t)}lastIndexOf(e,t=this.length-1){return this.items.lastIndexOf(e,t)}every(e,t){return this.items.every(e,t)}some(e,t){return this.items.some(e,t)}forEach(e,t){return this.items.forEach(e,t)}map(e,t){return this.items.map(e,t)}filter(e,t){return this.items.filter(e,t)}reduce(e,t){return this.items.reduce(e,t)}reduceRight(e,t){return this.items.reduceRight(e,t)}find(e,t){return this.items.find(e,t)}findIndex(e,t){return this.items.findIndex(e,t)}fill(e,t,r){throw new Error("ArraySchema#fill() not implemented")}copyWithin(e,t,r){throw new Error("ArraySchema#copyWithin() not implemented")}toString(){return this.items.toString()}toLocaleString(){return this.items.toLocaleString()}[Symbol.iterator](){return this.items[Symbol.iterator]()}static get[Symbol.species](){return t}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}includes(e,t){return this.items.includes(e,t)}flatMap(e,t){throw new Error("ArraySchema#flatMap() is not supported.")}flat(e){throw new Error("ArraySchema#flat() is not supported.")}findLast(){return this.items.findLast.apply(this.items,arguments)}findLastIndex(...e){return this.items.findLastIndex.apply(this.items,arguments)}with(e,r){const n=this.items.slice();return e<0&&(e+=this.length),n[e]=r,new t(...n)}toReversed(){return this.items.slice().reverse()}toSorted(e){return this.items.slice().sort(e)}toSpliced(e,t,...r){return this.items.toSpliced.apply(copy,arguments)}shuffle(){return this.move(e=>{let t=this.items.length;for(;0!=t;){let e=Math.floor(Math.random()*t);t--,[this[t],this[e]]=[this[e],this[t]]}})}move(e){return this.isMovingItems=!0,e(this),this.isMovingItems=!1,this}[a](e,t=!1){return t||this.deletedIndexes[e]?this.items[e]:this.tmpItems[e]||this.items[e]}[c](e){this.items[e]=void 0,this.tmpItems[e]=void 0}[u](){this.tmpItems=this.items.slice(),this.deletedIndexes={}}[d](){this.items=this.items.filter(e=>void 0!==e),this.tmpItems=this.items.slice()}toArray(){return this.items.slice(0)}toJSON(){return this.toArray().map(e=>"function"==typeof e.toJSON?e.toJSON():e)}clone(e){let r;return e?(r=new t,r.push(...this.items)):r=new t(...this.map(e=>e[l]?e.clone():e)),r}};Ae[Ee]=ge,Ae[Oe]=function(t,r,n,s,i){let o,a=r[n.offset++];if(a===e.OPERATION.CLEAR)return t.removeChildRefs(s,i),void s.clear();if(a===e.OPERATION.REVERSE)return void s.reverse();if(a===e.OPERATION.DELETE_BY_REFID){const a=Q.number(r,n),l=t.root.refs.get(a);return o=s.findIndex(e=>e===l),s[c](o),void i.push({ref:s,refId:t.currentRefId,op:e.OPERATION.DELETE,field:"",dynamicIndex:o,value:void 0,previousValue:l})}if(a===e.OPERATION.ADD_BY_REFID){const e=Q.number(r,n),i=t.root.refs.get(e);i&&(o=s.findIndex(e=>e===i)),-1!==o&&void 0!==o||(o=s.length)}else o=Q.number(r,n);const l=s[h];let u=o;const{value:d,previousValue:f}=me(t,a,s,o,l,r,n,i);null!=d&&d!==f&&s.$setAt(o,d,a),f!==d&&i.push({ref:s,refId:t.currentRefId,op:a,field:"",dynamicIndex:u,value:d,previousValue:f})};let Te=Ae;var Se,_e;re("array",{constructor:Te});const xe=class t{static[(Se=s,_e=i,o)](e,t,r){return!r||"string"==typeof e[h]||r.isChangeTreeVisible((e[a](t)??e.deletedItems[t])[l])}static is(e){return void 0!==e.map}constructor(e){this.$items=new Map,this.$indexes=new Map,this.deletedItems={};const r=new ue(this);if(r.indexes={},Object.defineProperty(this,l,{value:r,enumerable:!1,writable:!0}),e)if(e instanceof Map||e instanceof t)e.forEach((e,t)=>this.set(t,e));else for(const t in e)this.set(t,e[t]);Object.defineProperty(this,h,{value:void 0,enumerable:!1,writable:!0,configurable:!0})}[Symbol.iterator](){return this.$items[Symbol.iterator]()}get[Symbol.toStringTag](){return this.$items[Symbol.toStringTag]}static get[Symbol.species](){return t}set(t,r){var n;if(null==r)throw new Error(`MapSchema#set('${t}', ${r}): trying to set ${r} value on '${t}'.`);"object"==typeof r&&this[h]&&we(r,this[h],this,t),t=t.toString();const s=this[l],i=void 0!==r[l];let o,a;if(void 0!==s.indexes[t]){o=s.indexes[t],a=e.OPERATION.REPLACE;const c=this.$items.get(t);if(c===r)return;i&&(a=e.OPERATION.DELETE_AND_ADD,void 0!==c&&(null==(n=c[l].root)||n.remove(c[l]))),this.deletedItems[o]&&delete this.deletedItems[o]}else o=s.indexes[p]??0,a=e.OPERATION.ADD,this.$indexes.set(o,t),s.indexes[t]=o,s.indexes[p]=o+1;return this.$items.set(t,r),s.change(o,a),i&&r[l].setParent(this,s.root,o),this}get(e){return this.$items.get(e)}delete(e){const t=this[l].indexes[e];return this.deletedItems[t]=this[l].delete(t),this.$items.delete(e)}clear(){const t=this[l];t.discard(!0),t.indexes={},t.forEachChild((e,r)=>{var n;null==(n=t.root)||n.remove(e)}),this.$indexes.clear(),this.$items.clear(),t.operation(e.OPERATION.CLEAR)}has(e){return this.$items.has(e)}forEach(e){this.$items.forEach(e)}entries(){return this.$items.entries()}keys(){return this.$items.keys()}values(){return this.$items.values()}get size(){return this.$items.size}setIndex(e,t){this.$indexes.set(e,t)}getIndex(e){return this.$indexes.get(e)}[a](e){return this.$items.get(this.$indexes.get(e))}[c](e){const t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)}[u](){const e=this[l];for(const t in this.deletedItems){const r=parseInt(t),n=this.$indexes.get(r);delete e.indexes[n],this.$indexes.delete(r)}this.deletedItems={}}toJSON(){const e={};return this.forEach((t,r)=>{e[r]="function"==typeof t.toJSON?t.toJSON():t}),e}clone(e){let r;return e?r=Object.assign(new t,this):(r=new t,this.forEach((e,t)=>{e[l]?r.set(t,e.clone()):r.set(t,e)})),r}};xe[Se]=pe,xe[_e]=ve;let Ce=xe;var Pe,Re;re("map",{constructor:Ce});const ke=class t{static[(Pe=s,Re=i,o)](e,t,r){return!r||"string"==typeof e[h]||r.isChangeTreeVisible((e[a](t)??e.deletedItems[t])[l])}static is(e){return void 0!==e.collection}constructor(e){this.$items=new Map,this.$indexes=new Map,this.deletedItems={},this.$refId=0,this[l]=new ue(this),this[l].indexes={},e&&e.forEach(e=>this.add(e)),Object.defineProperty(this,h,{value:void 0,enumerable:!1,writable:!0,configurable:!0})}add(e){const t=this.$refId++;return void 0!==e[l]&&e[l].setParent(this,this[l].root,t),this[l].indexes[t]=t,this.$indexes.set(t,t),this.$items.set(t,e),this[l].change(t),t}at(e){const t=Array.from(this.$items.keys())[e];return this.$items.get(t)}entries(){return this.$items.entries()}delete(e){const t=this.$items.entries();let r,n;for(;(n=t.next())&&!n.done;)if(e===n.value[1]){r=n.value[0];break}return void 0!==r&&(this.deletedItems[r]=this[l].delete(r),this.$indexes.delete(r),this.$items.delete(r))}clear(){const t=this[l];t.discard(!0),t.indexes={},t.forEachChild((e,r)=>{var n;null==(n=t.root)||n.remove(e)}),this.$indexes.clear(),this.$items.clear(),t.operation(e.OPERATION.CLEAR)}has(e){return Array.from(this.$items.values()).some(t=>t===e)}forEach(e){this.$items.forEach((t,r,n)=>e(t,r,this))}values(){return this.$items.values()}get size(){return this.$items.size}[Symbol.iterator](){return this.$items.values()}setIndex(e,t){this.$indexes.set(e,t)}getIndex(e){return this.$indexes.get(e)}[a](e){return this.$items.get(this.$indexes.get(e))}[c](e){const t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)}[u](){this.deletedItems={}}toArray(){return Array.from(this.$items.values())}toJSON(){const e=[];return this.forEach((t,r)=>{e.push("function"==typeof t.toJSON?t.toJSON():t)}),e}clone(e){let r;return e?r=Object.assign(new t,this):(r=new t,this.forEach(e=>{e[l]?r.add(e.clone()):r.add(e)})),r}};ke[Pe]=pe,ke[Re]=ve;let De=ke;var Ne,$e;re("collection",{constructor:De});const Me=class t{static[(Ne=s,$e=i,o)](e,t,r){return!r||"string"==typeof e[h]||r.visible.has((e[a](t)??e.deletedItems[t])[l])}static is(e){return void 0!==e.set}constructor(e){this.$items=new Map,this.$indexes=new Map,this.deletedItems={},this.$refId=0,this[l]=new ue(this),this[l].indexes={},e&&e.forEach(e=>this.add(e)),Object.defineProperty(this,h,{value:void 0,enumerable:!1,writable:!0,configurable:!0})}add(t){var r;if(this.has(t))return!1;const n=this.$refId++;void 0!==t[l]&&t[l].setParent(this,this[l].root,n);const s=(null==(r=this[l].indexes[n])?void 0:r.op)??e.OPERATION.ADD;return this[l].indexes[n]=n,this.$indexes.set(n,n),this.$items.set(n,t),this[l].change(n,s),n}entries(){return this.$items.entries()}delete(e){const t=this.$items.entries();let r,n;for(;(n=t.next())&&!n.done;)if(e===n.value[1]){r=n.value[0];break}return void 0!==r&&(this.deletedItems[r]=this[l].delete(r),this.$indexes.delete(r),this.$items.delete(r))}clear(){const t=this[l];t.discard(!0),t.indexes={},this.$indexes.clear(),this.$items.clear(),t.operation(e.OPERATION.CLEAR)}has(e){const t=this.$items.values();let r,n=!1;for(;(r=t.next())&&!r.done;)if(e===r.value){n=!0;break}return n}forEach(e){this.$items.forEach((t,r,n)=>e(t,r,this))}values(){return this.$items.values()}get size(){return this.$items.size}[Symbol.iterator](){return this.$items.values()}setIndex(e,t){this.$indexes.set(e,t)}getIndex(e){return this.$indexes.get(e)}[a](e){return this.$items.get(this.$indexes.get(e))}[c](e){const t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)}[u](){this.deletedItems={}}toArray(){return Array.from(this.$items.values())}toJSON(){const e=[];return this.forEach((t,r)=>{e.push("function"==typeof t.toJSON?t.toJSON():t)}),e}clone(e){let r;return e?r=Object.assign(new t,this):(r=new t,this.forEach(e=>{e[l]?r.add(e.clone()):r.add(e)})),r}};Me[Ne]=pe,Me[$e]=ve;let je=Me;re("set",{constructor:je});const Le=-1;function Be(e=-1){return function(t,r){var n;const s=t.constructor,i=Object.getPrototypeOf(s)[Symbol.metadata],o=s[n=Symbol.metadata]??(s[n]=Object.assign({},s[Symbol.metadata],i??Object.create(null)));ae.setTag(o,r,e)}}function Fe(e,t){return function(r,n){const s=r.constructor;if(!e)throw new Error(`${s.name}: @type() reference provided for "${n}" is undefined. Make sure you don't have any circular dependencies.`);e=oe(e),ie.register(s);const i=Object.getPrototypeOf(s)[Symbol.metadata],o=ae.initialize(s);let a=o[n];if(void 0!==o[a]){if(o[a].deprecated)return;if(void 0!==o[a].type)try{throw new Error(`@colyseus/schema: Duplicate '${n}' definition on '${s.name}'.\nCheck @type() annotation`)}catch(st){const t=st.stack.split("\n")[4].trim();throw new Error(`${st.message} ${t}`)}}else a=o[p]??(i&&i[p])??-1,a++;if(t&&t.manual)ae.addField(o,a,n,e,{enumerable:!0,configurable:!0,writable:!0});else{const t="string"==typeof Object.keys(e)[0]&&ne(Object.keys(e)[0]),r=t?Object.values(e)[0]:e;ae.addField(o,a,n,e,Ue(`_${n}`,a,r,t))}}}function Ue(t,r,s,i){return{get:function(){return this[t]},set:function(o){var a,c;const u=this[t]??void 0;if(o!==u){if(null!=o){i?(i.constructor!==Te||o instanceof Te||(o=new Te(...o)),i.constructor!==Ce||o instanceof Ce||(o=new Ce(o)),o[h]=s):"string"!=typeof s?we(o,s,this,t.substring(1)):function(e,t,r,n){let s,i=!1;switch(t){case"number":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"float32":case"float64":s="number",isNaN(e)&&console.log(`trying to encode "NaN" in ${r.constructor.name}#${n}`);break;case"bigint64":case"biguint64":s="bigint";break;case"string":s="string",i=!0;break;default:return}if(typeof e!==s&&(!i||i&&null!==e)){let t=`'${JSON.stringify(e)}'${e&&e.constructor&&` (${e.constructor.name})`||""}`;throw new be(`a '${s}' was expected, but ${t} was provided in ${r.constructor.name}#${n}`)}}(o,s,this,t.substring(1));const d=this[l];void 0!==u&&u[l]?(null==(a=d.root)||a.remove(u[l]),this.constructor[n](d,r,e.OPERATION.DELETE_AND_ADD)):this.constructor[n](d,r,e.OPERATION.ADD),null==(c=o[l])||c.setParent(this,d.root,r)}else void 0!==u&&this[l].delete(r);this[t]=o}},enumerable:!0,configurable:!0}}function Ve(e){return new Array(e).fill(0).map((t,r)=>r===e-1?"└─ ":"   ").join("")}var ze,We;const He=class t{static initialize(e){var t;Object.defineProperty(e,l,{value:new ue(e),enumerable:!1,writable:!0}),Object.defineProperties(e,(null==(t=e.constructor[Symbol.metadata])?void 0:t[f])||{})}static is(e){return"object"==typeof e[Symbol.metadata]}static[(ze=s,We=i,n)](t,r,n=e.OPERATION.ADD){t.change(r,n)}static[o](e,t,r){var n,s;const i=null==(n=e.constructor[Symbol.metadata][t])?void 0:n.tag;if(void 0===r)return void 0===i;if(void 0===i)return!0;if(i===Le)return r.isChangeTreeVisible(e[l]);{const t=null==(s=r.tags)?void 0:s.get(e[l]);return t&&t.has(i)}}constructor(...e){t.initialize(this),e[0]&&Object.assign(this,e[0])}assign(e){return Object.assign(this,e),this}setDirty(e,t){const r=this.constructor[Symbol.metadata];this[l].change(r[r[e]].index,t)}clone(){var e;const t=new this.constructor,r=this.constructor[Symbol.metadata];for(const n in r){const s=r[n].name;"object"==typeof this[s]&&"function"==typeof(null==(e=this[s])?void 0:e.clone)?t[s]=this[s].clone():t[s]=this[s]}return t}toJSON(){const e={},t=this.constructor[Symbol.metadata];for(const r in t){const n=t[r],s=n.name;n.deprecated||null===this[s]||void 0===this[s]||(e[s]="function"==typeof this[s].toJSON?this[s].toJSON():this[s])}return e}discardAllChanges(){this[l].discardAll()}[a](e){return this[this.constructor[Symbol.metadata][e].name]}[c](e){this[this.constructor[Symbol.metadata][e].name]=void 0}static debugRefIds(e,t=!1,r=0,n,s=""){var i;const o=t?` - ${JSON.stringify(e.toJSON())}`:"",a=e[l],c=n?n.root.refIds.get(e):a.refId,h=n?n.root:a.root,u=(null==(i=null==h?void 0:h.refCount)?void 0:i[c])>1?` [×${h.refCount[c]}]`:"";let d=`${Ve(r)}${s}${e.constructor.name} (refId: ${c})${u}${o}\n`;return a.forEachChild((s,i)=>{let o=i;"number"==typeof i&&e.$indexes&&(o=e.$indexes.get(i)??i);const a=void 0!==e.forEach&&void 0!==o?`["${o}"]: `:"";d+=this.debugRefIds(s.ref,t,r+1,n,a)}),d}static debugRefIdEncodingOrder(e,t="allChanges"){let r=[],n=e[l].root[t].next;for(;n;)n.changeTree&&r.push(n.changeTree.refId),n=n.next;return r}static debugRefIdsFromDecoder(e){return this.debugRefIds(e.state,!1,0,e)}static debugChanges(t,r=!1){const n=t[l],s=r?n.allChanges:n.changes,i=r?"allChanges":"changes";let o=`${t.constructor.name} (${n.refId}) -> .${i}:\n`;function a(t){t.operations.filter(e=>e).forEach(t=>{const s=n.indexedOperations[t];o+=`- [${t}]: ${e.OPERATION[s]} (${JSON.stringify(n.getValue(Number(t),r))})\n`})}return a(s),!r&&n.filteredChanges&&n.filteredChanges.operations.filter(e=>e).length>0&&(o+=`${t.constructor.name} (${n.refId}) -> .filteredChanges:\n`,a(n.filteredChanges)),r&&n.allFilteredChanges&&n.allFilteredChanges.operations.filter(e=>e).length>0&&(o+=`${t.constructor.name} (${n.refId}) -> .allFilteredChanges:\n`,a(n.allFilteredChanges)),o}static debugChangesDeep(t,r="changes"){var n,s;let i="";const o=t[l],a=o.root,c=new Map,h=[];let u=0;for(const[e,f]of Object.entries(a[r])){const r=a.changeTrees[e];if(!r)continue;let i=!1,d=[],p=null==(n=r.parent)?void 0:n[l];if(r===o)i=!0;else for(;void 0!==p;){if(d.push(p),p.ref===t){i=!0;break}p=null==(s=p.parent)?void 0:s[l]}i&&(h.push(r.refId),u+=Object.keys(f).length,c.set(r,d.reverse()))}i+="---\n",i+=`root refId: ${o.refId}\n`,i+=`Total instances: ${h.length} (refIds: ${h.join(", ")})\n`,i+=`Total changes: ${u}\n`,i+="---\n";const d=new WeakSet;for(const[l,f]of c.entries()){f.forEach((e,t)=>{d.has(e)||(i+=`${Ve(t)}${e.ref.constructor.name} (refId: ${e.refId})\n`,d.add(e))});const t=l.indexedOperations,r=f.length,n=Ve(r),s=r>0?`(${l.parentIndex}) `:"";i+=`${n}${s}${l.ref.constructor.name} (refId: ${l.refId}) - changes: ${Object.keys(t).length}\n`;for(const o in t){const n=t[o];i+=`${Ve(r+1)}${e.OPERATION[n]}: ${o}\n`}}return`${i}`}};He[ze]=fe,He[We]=ye;let qe=He;function Je(e,t,r,n){var s,i=arguments.length,o=i<3?t:n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,r,o):s(t,r))||o);return i>3&&o&&Object.defineProperty(t,r,o),o}"function"==typeof SuppressedError&&SuppressedError;class Ke{constructor(e){this.types=e,this.nextUniqueId=0,this.refCount={},this.changeTrees={},this.allChanges={next:void 0,tail:void 0},this.allFilteredChanges={next:void 0,tail:void 0},this.changes={next:void 0,tail:void 0},this.filteredChanges={next:void 0,tail:void 0}}getNextUniqueId(){return this.nextUniqueId++}add(t){void 0===t.refId&&(t.refId=this.getNextUniqueId());const r=void 0===this.changeTrees[t.refId];r&&(this.changeTrees[t.refId]=t);const n=this.refCount[t.refId];if(0===n){const r=t.allChanges.operations;let n=r.length;for(;n--;)t.indexedOperations[r[n]]=e.OPERATION.ADD,le(t.changes,n)}return this.refCount[t.refId]=(n||0)+1,r}remove(e){const t=this.refCount[e.refId]-1;return t<=0?(e.root=void 0,delete this.changeTrees[e.refId],this.removeChangeFromChangeSet("allChanges",e),this.removeChangeFromChangeSet("changes",e),e.filteredChanges&&(this.removeChangeFromChangeSet("allFilteredChanges",e),this.removeChangeFromChangeSet("filteredChanges",e)),this.refCount[e.refId]=0,e.forEachChild((t,r)=>{t.removeParent(e.ref)&&(void 0===t.parentChain||t.parentChain&&this.refCount[t.refId]>0?this.remove(t):t.parentChain&&this.moveNextToParent(t))})):(this.refCount[e.refId]=t,this.recursivelyMoveNextToParent(e)),t}recursivelyMoveNextToParent(e){this.moveNextToParent(e),e.forEachChild((e,t)=>this.recursivelyMoveNextToParent(e))}moveNextToParent(e){e.filteredChanges?(this.moveNextToParentInChangeTreeList("filteredChanges",e),this.moveNextToParentInChangeTreeList("allFilteredChanges",e)):(this.moveNextToParentInChangeTreeList("changes",e),this.moveNextToParentInChangeTreeList("allChanges",e))}moveNextToParentInChangeTreeList(e,t){var r;const n=this[e],s=t[e].queueRootNode;if(!s)return;const i=t.parent;if(!i||!i[l])return;const o=null==(r=i[l][e])?void 0:r.queueRootNode;if(!o||o===s)return;const a=o.position;s.position>a||(s.prev?s.prev.next=s.next:n.next=s.next,s.next?s.next.prev=s.prev:n.tail=s.prev,s.prev=o,s.next=o.next,o.next?o.next.prev=s:n.tail=s,o.next=s,this.updatePositionsAfterMove(n,s,a+1))}enqueueChangeTree(e,t,r=e[t].queueRootNode){r||(e[t].queueRootNode=this.addToChangeTreeList(this[t],e))}addToChangeTreeList(e,t){const r={changeTree:t,next:void 0,prev:void 0,position:e.tail?e.tail.position+1:0};return e.next?(r.prev=e.tail,e.tail.next=r,e.tail=r):(e.next=r,e.tail=r),r}updatePositionsAfterRemoval(e,t){let r=e.next,n=0;for(;r;)n>=t&&(r.position=n),r=r.next,n++}updatePositionsAfterMove(e,t,r){let n=e.next,s=0;for(;n;)n.position=s,n=n.next,s++}removeChangeFromChangeSet(e,t){const r=this[e],n=t[e].queueRootNode;if(n&&n.changeTree===t){const s=n.position;return n.prev?n.prev.next=n.next:r.next=n.next,n.next?n.next.prev=n.prev:r.tail=n.prev,this.updatePositionsAfterRemoval(r,s),t[e].queueRootNode=void 0,!0}return!1}}const Ye=class t{constructor(e){this.sharedBuffer=Buffer.allocUnsafe(t.BUFFER_SIZE),this.context=ie.cache(e.constructor),this.root=new Ke(this.context),this.setState(e)}setState(e){this.state=e,this.state[l].setRoot(this.root)}encode(t={offset:0},r,n=this.sharedBuffer,i="changes",a="allChanges"===i,c=t.offset){const h=void 0!==r,u=this.state[l];let d=this.root[i];for(;d=d.next;){const l=d.changeTree;if(h){if(!r.isChangeTreeVisible(l)){r.invisible.add(l);continue}r.invisible.delete(l)}const f=l[i],p=l.ref,g=f.operations.length;if(0===g)continue;const m=p.constructor,y=m[s],v=m[o],b=m[Symbol.metadata];(h||t.offset>c||l!==u)&&(n[t.offset++]=255,$.number(n,l.refId,t));for(let s=0;s<g;s++){const i=f.operations[s];if(i<0){n[t.offset++]=255&Math.abs(i);continue}const o=a?e.OPERATION.ADD:l.indexedOperations[i];void 0===i||void 0===o||v&&!v(p,i,r)||y(this,n,l,i,o,t,a,h,b)}}if(t.offset>n.byteLength){const e=Math.ceil(t.offset/(Buffer.poolSize??8192))*(Buffer.poolSize??8192);return console.warn(`@colyseus/schema buffer overflow. Encoded state is higher than default BUFFER_SIZE. Use the following to increase default BUFFER_SIZE:\n\n    import { Encoder } from "@colyseus/schema";\n    Encoder.BUFFER_SIZE = ${Math.round(e/1024)} * 1024; // ${Math.round(e/1024)} KB\n`),(n=Buffer.alloc(e,n))===this.sharedBuffer&&(this.sharedBuffer=n),this.encode({offset:c},r,n,i,a)}return n.subarray(0,t.offset)}encodeAll(e={offset:0},t=this.sharedBuffer){return this.encode(e,void 0,t,"allChanges",!0)}encodeAllView(e,t,r,n=this.sharedBuffer){const s=r.offset;return this.encode(r,e,n,"allFilteredChanges",!0,s),Buffer.concat([n.subarray(0,t),n.subarray(s,r.offset)])}debugChanges(t){let r=("string"==typeof t?this.root[t]:t).next;for(;r;){const n=r.changeTree,s=n[t],i=n.ref.constructor[Symbol.metadata];console.log("->",{ref:n.ref.constructor.name,refId:n.refId,changes:Object.keys(s).length});for(const t in s){const r=s[t];console.log("  ->",{index:t,field:null==i?void 0:i[t],op:e.OPERATION[r]})}r=r.next}}encodeView(t,r,n,i=this.sharedBuffer){const o=n.offset;for(const[c,l]of t.changes){const r=this.root.changeTrees[c];if(void 0===r){t.changes.delete(c);continue}const o=Object.keys(l);if(0===o.length)continue;const h=r.ref.constructor,u=h[s],d=h[Symbol.metadata];i[n.offset++]=255,$.number(i,r.refId,n);for(let t=0,s=o.length;t<s;t++){const s=Number(o[t]),c=r.ref[a](s);u(this,i,r,s,void 0!==c&&l[s]||e.OPERATION.DELETE,n,!1,!0,d)}}return t.changes.clear(),this.encode(n,t,i,"filteredChanges",!1,o),Buffer.concat([i.subarray(0,r),i.subarray(o,n.offset)])}discardChanges(){let e=this.root.changes.next;for(;e;)e.changeTree.endEncode("changes"),e=e.next;for(this.root.changes={next:void 0,tail:void 0},e=this.root.filteredChanges.next;e;)e.changeTree.endEncode("filteredChanges"),e=e.next;this.root.filteredChanges={next:void 0,tail:void 0}}tryEncodeTypeId(e,t,r,n){const s=this.context.getTypeId(t),i=this.context.getTypeId(r);void 0!==i?s!==i&&(e[n.offset++]=213,$.number(e,i,n)):console.warn(`@colyseus/schema WARNING: Class "${r.name}" is not registered on TypeRegistry - Please either tag the class with @entity or define a @type() field.`)}get hasChanges(){return void 0!==this.root.changes.next||void 0!==this.root.filteredChanges.next}};Ye.BUFFER_SIZE="undefined"!=typeof Buffer&&Buffer.poolSize||8192;let Ge=Ye;function Xe(e,t){if(-1===t||t>=e.length)return!1;const r=e.length-1;for(let n=t;n<r;n++)e[n]=e[n+1];return e.length=r,!0}class Ze extends Error{constructor(e){super(e),this.name="DecodingWarning"}}class Qe{constructor(){this.refs=new Map,this.refIds=new WeakMap,this.refCount={},this.deletedRefs=new Set,this.callbacks={},this.nextUniqueId=0}getNextUniqueId(){return this.nextUniqueId++}addRef(e,t,r=!0){this.refs.set(e,t),this.refIds.set(t,e),r&&(this.refCount[e]=(this.refCount[e]||0)+1),this.deletedRefs.has(e)&&this.deletedRefs.delete(e)}removeRef(e){const t=this.refCount[e];if(void 0!==t)if(0!==t)(this.refCount[e]=t-1)<=0&&this.deletedRefs.add(e);else try{const t=this.refs.get(e);throw new Ze(`trying to remove refId '${e}' with 0 refCount (${t.constructor.name}: ${JSON.stringify(t)})`)}catch(st){console.warn(st)}else try{throw new Ze("trying to remove refId that doesn't exist: "+e)}catch(st){console.warn(st)}}clearRefs(){this.refs.clear(),this.deletedRefs.clear(),this.callbacks={},this.refCount={}}garbageCollectDeletedRefs(){this.deletedRefs.forEach(e=>{if(this.refCount[e]>0)return;const t=this.refs.get(e);if(void 0!==t.constructor[Symbol.metadata]){const e=t.constructor[Symbol.metadata];for(const r in e){const n=e[r].name,s="object"==typeof t[n]&&this.refIds.get(t[n]);s&&!this.deletedRefs.has(s)&&this.removeRef(s)}}else"function"==typeof t[h]&&Array.from(t.values()).forEach(e=>{const t=this.refIds.get(e);this.deletedRefs.has(t)||this.removeRef(t)});this.refs.delete(e),delete this.refCount[e],delete this.callbacks[e]}),this.deletedRefs.clear()}addCallback(t,r,n){if(void 0===t){const t="number"==typeof r?e.OPERATION[r]:r;throw new Error(`Can't addCallback on '${t}' (refId is undefined)`)}return this.callbacks[t]||(this.callbacks[t]={}),this.callbacks[t][r]||(this.callbacks[t][r]=[]),this.callbacks[t][r].push(n),()=>this.removeCallback(t,r,n)}removeCallback(e,t,r){var n,s,i;const o=null==(i=null==(s=null==(n=this.callbacks)?void 0:n[e])?void 0:s[t])?void 0:i.indexOf(r);void 0!==o&&-1!==o&&Xe(this.callbacks[e][t],o)}}class et{constructor(e,t){this.currentRefId=0,this.setState(e),this.context=t||new ie(e.constructor)}setState(e){this.state=e,this.root=new Qe,this.root.addRef(0,e)}decode(e,r={offset:0},n=this.state){var s,o,a;const c=[],l=this.root,h=e.byteLength;let u=n.constructor[i];for(this.currentRefId=0;r.offset<h;){if(e[r.offset]==t){r.offset++,null==(s=n[d])||s.call(n);const t=Q.number(e,r),o=l.refs.get(t);o?(u=(n=o).constructor[i],this.currentRefId=t):(console.error(`"refId" not found: ${t}`,{previousRef:n,previousRefId:this.currentRefId}),console.warn("Please report this issue to the developers."),this.skipCurrentStructure(e,r,h));continue}-1!==u(this,e,r,n,c)||(console.warn("@colyseus/schema: definition mismatch"),this.skipCurrentStructure(e,r,h))}return null==(o=n[d])||o.call(n),null==(a=this.triggerChanges)||a.call(this,c),l.garbageCollectDeletedRefs(),c}skipCurrentStructure(e,r,n){const s={offset:r.offset};for(;r.offset<n&&(e[r.offset]!==t||(s.offset=r.offset+1,!this.root.refs.has(Q.number(e,s))));)r.offset++}getInstanceType(e,t,r){let n;if(213===e[t.offset]){t.offset++;const r=Q.number(e,t);n=this.context.get(r)}return n||r}createInstanceOfType(e){return new e}removeChildRefs(t,r){const n="string"!=typeof t[h],s=this.root.refIds.get(t);t.forEach((i,o)=>{r.push({ref:t,refId:s,op:e.OPERATION.DELETE,field:o,value:void 0,previousValue:i}),n&&this.root.removeRef(this.root.refIds.get(i))})}}class tt extends qe{}Je([Fe("string")],tt.prototype,"name",void 0),Je([Fe("string")],tt.prototype,"type",void 0),Je([Fe("number")],tt.prototype,"referencedType",void 0);class rt extends qe{constructor(){super(...arguments),this.fields=new Te}}Je([Fe("number")],rt.prototype,"id",void 0),Je([Fe("number")],rt.prototype,"extendsId",void 0),Je([Fe([tt])],rt.prototype,"fields",void 0);class nt extends qe{constructor(){super(...arguments),this.types=new Te}static encode(e,t={offset:0}){const r=e.context,n=new nt,s=new Ge(n),i=r.schemas.get(e.state.constructor);i>0&&(n.rootType=i);const o=new Set,a={},c=e=>{if(void 0===e.extendsId||o.has(e.extendsId)){o.add(e.id),n.types.push(e);const t=a[e.id];void 0!==t&&(delete a[e.id],t.forEach(e=>c(e)))}else void 0===a[e.extendsId]&&(a[e.extendsId]=[]),a[e.extendsId].push(e)};r.schemas.forEach((e,t)=>{const n=new rt;n.id=Number(e);const s=Object.getPrototypeOf(t);s!==qe&&(n.extendsId=r.schemas.get(s));const i=t[Symbol.metadata];if(i!==s[Symbol.metadata])for(const o in i){const e=Number(o),t=i[e].name;if(!Object.prototype.hasOwnProperty.call(i,t))continue;const s=new tt;let a;s.name=t;const c=i[e];if("string"==typeof c.type)a=c.type;else{let e;qe.is(c.type)?(a="ref",e=c.type):(a=Object.keys(c.type)[0],"string"==typeof c.type[a]?a+=":"+c.type[a]:e=c.type[a]),s.referencedType=e?r.getTypeId(e):-1}s.type=a,n.fields.push(s)}c(n)});for(const h in a)a[h].forEach(e=>n.types.push(e));const l=s.encodeAll(t);return Buffer.from(l,0,t.offset)}static decode(e,t){const r=new nt;new et(r).decode(e,t);const n=new ie;r.types.forEach(e=>{const t=n.get(e.extendsId)??qe,r=class extends t{};ie.register(r),n.add(r,e.id)},{});r.types.forEach(e=>{const t=n.get(e.id),s=ae.initialize(t),i=[];let o=e;do{i.push(o),o=r.types.find(e=>e.id===o.extendsId)}while(o);let a=0;i.reverse().forEach(e=>{((e,t,r)=>{t.fields.forEach((t,s)=>{const i=r+s;if(void 0!==t.referencedType){let r=t.type,s=n.get(t.referencedType);if(!s){const e=t.type.split(":");r=e[0],s=e[1]}"ref"===r?ae.addField(e,i,t.name,s):ae.addField(e,i,t.name,{[r]:s})}else ae.addField(e,i,t.name,t.type)})})(s,e,a),a+=e.fields.length})});const s=new(n.get(r.rootType||0));return new et(s,n)}}Je([Fe([rt])],nt.prototype,"types",void 0),Je([Fe("number")],nt.prototype,"rootType",void 0);re("map",{constructor:Ce}),re("array",{constructor:Te}),re("set",{constructor:je}),re("collection",{constructor:De}),e.$changes=l,e.$childType=h,e.$decoder=i,e.$deleteByIndex=c,e.$encoder=s,e.$filter=o,e.$getByIndex=a,e.$track=n,e.ArraySchema=Te,e.ChangeTree=ue,e.CollectionSchema=De,e.Decoder=et,e.Encoder=Ge,e.MapSchema=Ce,e.Metadata=ae,e.Reflection=nt,e.ReflectionField=tt,e.ReflectionType=rt,e.Schema=qe,e.SetSchema=je,e.StateView=class{constructor(e=!1){this.iterable=e,this.visible=new WeakSet,this.invisible=new WeakSet,this.changes=new Map,e&&(this.items=[])}add(t,r=-1,n=!0){var s,i;const o=null==t?void 0:t[l],a=o.parent;if(!o)return console.warn("StateView#add(), invalid object:",t),!1;if(!a&&0!==o.refId)throw new Error(`Cannot add a detached instance to the StateView. Make sure to assign the "${o.ref.constructor.name}" instance to the state before calling view.add()`);const c=t.constructor[Symbol.metadata];this.visible.add(o),this.iterable&&n&&this.items.push(t),n&&a&&this.addParentOf(o,r);let h=this.changes.get(o.refId);void 0===h&&(h={},this.changes.set(o.refId,h));let u=!1;if(o.forEachChild((e,t)=>{c&&void 0!==c[t].tag&&c[t].tag!==r||this.add(e.ref,r,!1)&&(u=!0)}),r!==Le){let t;this.tags||(this.tags=new WeakMap),this.tags.has(o)?t=this.tags.get(o):(t=new Set,this.tags.set(o,t)),t.add(r),null==(i=null==(s=null==c?void 0:c[y])?void 0:s[r])||i.forEach(t=>{o.getChange(t)!==e.OPERATION.DELETE&&(h[t]=e.OPERATION.ADD)})}else if(!o.isNew||u){const t=void 0!==o.filteredChanges?o.allFilteredChanges:o.allChanges,n=this.invisible.has(o);for(let s=0,i=t.operations.length;s<i;s++){const i=t.operations[s];if(void 0===i)continue;const a=o.indexedOperations[i]??e.OPERATION.ADD,l=null==c?void 0:c[i].tag;a===e.OPERATION.DELETE||!n&&void 0!==l&&l!==r||(h[i]=a,u=!0)}}return u}addParentOf(t,r){var n;const s=t.parent[l],i=t.parentIndex;if(!this.visible.has(s)){this.visible.add(s);const e=null==(n=s.parent)?void 0:n[l];e&&void 0!==e.filteredChanges&&this.addParentOf(s,r)}if(s.getChange(i)!==e.OPERATION.DELETE){let t,n=this.changes.get(s.refId);void 0===n&&(n={},this.changes.set(s.refId,n)),this.tags||(this.tags=new WeakMap),this.tags.has(s)?t=this.tags.get(s):(t=new Set,this.tags.set(s,t)),t.add(r),n[i]=e.OPERATION.ADD}}remove(t,r=-1,n=!1){var s;const i=t[l];if(!i)return console.warn("StateView#remove(), invalid object:",t),this;this.visible.delete(i),this.iterable&&!n&&Xe(this.items,this.items.indexOf(t));const o=i.ref.constructor[Symbol.metadata];let a=this.changes.get(i.refId);if(void 0===a&&(a={},this.changes.set(i.refId,a)),r===Le){const t=i.parent;if(t&&!ae.isValidInstance(t)&&i.isFiltered){const r=t[l];let n=this.changes.get(r.refId);void 0===n?(n={},this.changes.set(r.refId,n)):n[i.parentIndex]===e.OPERATION.ADD&&this.changes.delete(i.refId),n[i.parentIndex]=e.OPERATION.DELETE,this._recursiveDeleteVisibleChangeTree(i)}else null==(s=null==o?void 0:o[m])||s.forEach(t=>a[t]=e.OPERATION.DELETE)}else null==o||o[y][r].forEach(t=>a[t]=e.OPERATION.DELETE);if(this.tags&&this.tags.has(i)){const e=this.tags.get(i);void 0===r?this.tags.delete(i):(e.delete(r),0===e.size&&this.tags.delete(i))}return this}has(e){return this.visible.has(e[l])}hasTag(e,t=-1){var r;const n=null==(r=this.tags)?void 0:r.get(e[l]);return(null==n?void 0:n.has(t))??!1}clear(){if(!this.iterable)throw new Error("StateView#clear() is only available for iterable StateView's. Use StateView(iterable: true) constructor.");for(let e=0,t=this.items.length;e<t;e++)this.remove(this.items[e],Le,!0);this.items.length=0}isChangeTreeVisible(e){let t=this.visible.has(e);return!t&&e.isVisibilitySharedWithParent&&this.visible.has(e.parent[l])&&(this.visible.add(e),t=!0),t}_recursiveDeleteVisibleChangeTree(e){e.forEachChild(e=>{this.visible.delete(e),this._recursiveDeleteVisibleChangeTree(e)})}},e.TypeContext=ie,e.decode=Q,e.decodeKeyValueOperation=ve,e.decodeSchemaOperation=ye,e.defineCustomTypes=function(e){for(const t in e)re(t,e[t]);return e=>Fe(e)},e.defineTypes=function(e,t,r){for(let n in t)Fe(t[n],r)(e.prototype,n);return e},e.deprecated=function(e=!0){return function(t,r){var n;const s=t.constructor,i=Object.getPrototypeOf(s)[Symbol.metadata],o=s[n=Symbol.metadata]??(s[n]=Object.assign({},s[Symbol.metadata],i??Object.create(null))),a=o[r];o[a].deprecated=!0,e&&(o[f]??(o[f]={}),o[f][r]={get:function(){throw new Error(`${r} is deprecated.`)},set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(o,a,{value:o[a],enumerable:!1,configurable:!0})}},e.dumpChanges=function(t){const r={ops:{},refs:[]};let n=t[l].root.changes.next;for(;n;){const t=n.changeTree;if(void 0===t){n=n.next;continue}const s=t.indexedOperations;r.refs.push(`refId#${t.refId}`);for(const n in s){const t=s[n],i=e.OPERATION[t];r.ops[i]||(r.ops[i]=0),r.ops[e.OPERATION[t]]++}n=n.next}return r},e.encode=$,e.encodeArray=ge,e.encodeKeyValueOperation=pe,e.encodeSchemaOperation=fe,e.entity=function(e){return ie.register(e),e},e.getDecoderStateCallbacks=function(t){const r=t.root,n=r.callbacks,s=new WeakMap;let i;function o(t,n){var c;let l=(null==(c=n.instance)?void 0:c.constructor[Symbol.metadata])||t,h=n.instance&&"function"==typeof n.instance.forEach||t&&void 0===t[Symbol.metadata];if(l&&!h){const t=function(e,t,o,a){return a&&void 0!==n.instance[t]&&!s.has(i)&&o(n.instance[t],void 0),r.addCallback(r.refIds.get(e),t,o)};return new Proxy({listen:function(e,r,o=!0){if(n.instance)return t(n.instance,e,r,o);{let a=()=>{};return n.onInstanceAvailable((n,c)=>{a=t(n,e,r,o&&c&&!s.has(i))}),()=>a()}},onChange:function(t){return r.addCallback(r.refIds.get(n.instance),e.OPERATION.REPLACE,t)},bindTo:function(t,s){return s||(s=Object.keys(l).map(e=>l[e].name)),r.addCallback(r.refIds.get(n.instance),e.OPERATION.REPLACE,()=>{s.forEach(e=>t[e]=n.instance[e])})}},{get(e,t){var s;const i=l[l[t]];if(i){const e=null==(s=n.instance)?void 0:s[t],c=s=>{const i=a(n.instance).listen(t,(e,t)=>{s(e,!1),null==i||i()},!1);void 0!==r.refIds.get(e)&&s(e,!0)};return o(i.type,{instance:r.refIds.get(e)&&e,parentInstance:n.instance,onInstanceAvailable:c})}return e[t]},has:(e,t)=>void 0!==l[t],set(e,t,r){throw new Error("not allowed")},deleteProperty(e,t){throw new Error("not allowed")}})}{const t=function(t,n,o){return o&&t.forEach((e,t)=>n(e,t)),r.addCallback(r.refIds.get(t),e.OPERATION.ADD,(e,t)=>{s.set(n,!0),i=n,n(e,t),s.delete(n),i=void 0})},o=function(t,n){return r.addCallback(r.refIds.get(t),e.OPERATION.DELETE,n)},a=function(t,n){return r.addCallback(r.refIds.get(t),e.OPERATION.REPLACE,n)};return new Proxy({onAdd:function(e,r=!0){if(n.instance)return t(n.instance,e,r&&!s.has(i));if(n.onInstanceAvailable){let o=()=>{};return n.onInstanceAvailable((n,a)=>{o=t(n,e,r&&a&&!s.has(i))}),()=>o()}},onRemove:function(e){if(n.instance)return o(n.instance,e);if(n.onInstanceAvailable){let t=()=>{};return n.onInstanceAvailable(r=>{t=o(r,e)}),()=>t()}},onChange:function(e){if(n.instance)return a(n.instance,e);if(n.onInstanceAvailable){let t=()=>{};return n.onInstanceAvailable(r=>{t=a(r,e)}),()=>t()}}},{get(e,t){if(!e[t])throw new Error(`Can't access '${t}' through callback proxy. access the instance directly.`);return e[t]},has:(e,t)=>void 0!==e[t],set(e,t,r){throw new Error("not allowed")},deleteProperty(e,t){throw new Error("not allowed")}})}}function a(e){return o(void 0,{instance:e})}return t.triggerChanges=function(t){var s;const i=new Set;for(let o=0,a=t.length;o<a;o++){const a=t[o],c=a.refId,l=a.ref,h=n[c];if(h){if((a.op&e.OPERATION.DELETE)===e.OPERATION.DELETE&&a.previousValue instanceof qe){const t=null==(s=n[r.refIds.get(a.previousValue)])?void 0:s[e.OPERATION.DELETE];for(let e=(null==t?void 0:t.length)-1;e>=0;e--)t[e]()}if(l instanceof qe){if(!i.has(c)){const t=null==h?void 0:h[e.OPERATION.REPLACE];for(let e=(null==t?void 0:t.length)-1;e>=0;e--)t[e]()}if(h.hasOwnProperty(a.field)){const e=h[a.field];for(let t=(null==e?void 0:e.length)-1;t>=0;t--)e[t](a.value,a.previousValue)}}else{if((a.op&e.OPERATION.DELETE)===e.OPERATION.DELETE){if(void 0!==a.previousValue){const t=h[e.OPERATION.DELETE];for(let e=(null==t?void 0:t.length)-1;e>=0;e--)t[e](a.previousValue,a.dynamicIndex??a.field)}if((a.op&e.OPERATION.ADD)===e.OPERATION.ADD){const t=h[e.OPERATION.ADD];for(let e=(null==t?void 0:t.length)-1;e>=0;e--)t[e](a.value,a.dynamicIndex??a.field)}}else if((a.op&e.OPERATION.ADD)===e.OPERATION.ADD&&a.previousValue!==a.value){const t=h[e.OPERATION.ADD];for(let e=(null==t?void 0:t.length)-1;e>=0;e--)t[e](a.value,a.dynamicIndex??a.field)}if(a.value!==a.previousValue&&(void 0!==a.value||void 0!==a.previousValue)){const t=h[e.OPERATION.REPLACE];for(let e=(null==t?void 0:t.length)-1;e>=0;e--)t[e](a.value,a.dynamicIndex??a.field)}}i.add(c)}}},a},e.getRawChangesCallback=function(e,t){e.triggerChanges=t},e.registerType=re,e.schema=function e(t,r,n=qe){const s={},i={},o={},a={};for(let l in t){const e=t[l];"object"==typeof e?(void 0!==e.view&&(a[l]="boolean"==typeof e.view?Le:e.view),s[l]=oe(e),Object.prototype.hasOwnProperty.call(e,"default")?o[l]=e.default:Array.isArray(e)||void 0!==e.array?o[l]=new Te:void 0!==e.map?o[l]=new Ce:void 0!==e.collection?o[l]=new De:void 0!==e.set?o[l]=new je:void 0!==e.type&&qe.is(e.type)&&(o[l]=new e.type)):"function"==typeof e?qe.is(e)?(o[l]=new e,s[l]=oe(e)):i[l]=e:s[l]=oe(e)}const c=ae.setFields(class extends n{constructor(...e){e[0]=Object.assign({},(()=>{const e={};for(const t in o){const r=o[t];r&&"function"==typeof r.clone?e[t]=r.clone():e[t]=r}return e})(),e[0]),super(...e)}},s);for(let l in a)Be(a[l])(c.prototype,l);for(let l in i)c.prototype[l]=i[l];return r&&Object.defineProperty(c,"name",{value:r}),c.extends=(t,r)=>e(t,r,c),c},e.type=Fe,e.view=Be}(ee.exports)),ee.exports}var re,ne,se,ie,oe={};function ae(){if(ie)return Z;ie=1;var e=function(){if(G)return Q;G=1;var e=H,t=te();return Q.H3TransportTransport=class{constructor(e){this.events=e,this.isOpen=!1,this.lengthPrefixBuffer=new Uint8Array(9)}connect(e,t={}){const r=t.fingerprint&&{serverCertificateHashes:[{algorithm:"sha-256",value:new Uint8Array(t.fingerprint).buffer}]}||void 0;this.wt=new WebTransport(e,r),this.wt.ready.then(e=>{console.log("WebTransport ready!",e),this.isOpen=!0,this.unreliableReader=this.wt.datagrams.readable.getReader(),this.unreliableWriter=this.wt.datagrams.writable.getWriter(),this.wt.incomingBidirectionalStreams.getReader().read().then(e=>{this.reader=e.value.readable.getReader(),this.writer=e.value.writable.getWriter(),this.sendSeatReservation(t.room.roomId,t.sessionId,t.reconnectionToken),this.readIncomingData(),this.readIncomingUnreliableData()}).catch(e=>{console.error("failed to read incoming stream",e),console.error("TODO: close the connection")})}).catch(e=>{console.log("WebTransport not ready!",e),this._close()}),this.wt.closed.then(e=>{console.log("WebTransport closed w/ success",e),this.events.onclose({code:e.closeCode,reason:e.reason})}).catch(e=>{console.log("WebTransport closed w/ error",e),this.events.onerror(e),this.events.onclose({code:e.closeCode,reason:e.reason})}).finally(()=>{this._close()})}send(e){const r=t.encode.number(this.lengthPrefixBuffer,e.length,{offset:0}),n=new Uint8Array(r+e.length);n.set(this.lengthPrefixBuffer.subarray(0,r),0),n.set(e,r),this.writer.write(n)}sendUnreliable(e){const r=t.encode.number(this.lengthPrefixBuffer,e.length,{offset:0}),n=new Uint8Array(r+e.length);n.set(this.lengthPrefixBuffer.subarray(0,r),0),n.set(e,r),this.unreliableWriter.write(n)}close(e,t){try{this.wt.close({closeCode:e,reason:t})}catch(r){console.error(r)}}readIncomingData(){return e.__awaiter(this,void 0,void 0,function*(){let e;for(;this.isOpen;){try{e=yield this.reader.read();const r=e.value,n={offset:0};do{const e=t.decode.number(r,n);this.events.onmessage({data:r.subarray(n.offset,n.offset+e)}),n.offset+=e}while(n.offset<r.length)}catch(r){-1===r.message.indexOf("session is closed")&&console.error("H3Transport: failed to read incoming data",r);break}if(e.done)break}})}readIncomingUnreliableData(){return e.__awaiter(this,void 0,void 0,function*(){let e;for(;this.isOpen;){try{e=yield this.unreliableReader.read();const r=e.value,n={offset:0};do{const e=t.decode.number(r,n);this.events.onmessage({data:r.subarray(n.offset,n.offset+e)}),n.offset+=e}while(n.offset<r.length)}catch(r){-1===r.message.indexOf("session is closed")&&console.error("H3Transport: failed to read incoming data",r);break}if(e.done)break}})}sendSeatReservation(e,r,n){const s={offset:0},i=[];t.encode.string(i,e,s),t.encode.string(i,r,s),n&&t.encode.string(i,n,s),this.writer.write(new Uint8Array(i).buffer)}_close(){this.isOpen=!1}},Q}(),t=function(){if(se)return oe;se=1;var e=ne?re:(ne=1,re=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")});const t=globalThis.WebSocket||e;return oe.WebSocketTransport=class{constructor(e){this.events=e}send(e){this.ws.send(e)}sendUnreliable(e){console.warn("colyseus.js: The WebSocket transport does not support unreliable messages")}connect(e,r){try{this.ws=new t(e,{headers:r,protocols:this.protocols})}catch(n){this.ws=new t(e,this.protocols)}this.ws.binaryType="arraybuffer",this.ws.onopen=this.events.onopen,this.ws.onmessage=this.events.onmessage,this.ws.onclose=this.events.onclose,this.ws.onerror=this.events.onerror}close(e,t){this.ws.close(e,t)}get isOpen(){return this.ws.readyState===t.OPEN}},oe}();return Z.Connection=class{constructor(r){this.events={},this.transport="h3"===r?new e.H3TransportTransport(this.events):new t.WebSocketTransport(this.events)}connect(e,t){this.transport.connect.call(this.transport,e,t)}send(e){this.transport.send(e)}sendUnreliable(e){this.transport.sendUnreliable(e)}close(e,t){this.transport.close(e,t)}get isOpen(){return this.transport.isOpen}},Z}var ce,le={};function he(){return ce||(ce=1,(e=le).Protocol=void 0,(t=e.Protocol||(e.Protocol={}))[t.HANDSHAKE=9]="HANDSHAKE",t[t.JOIN_ROOM=10]="JOIN_ROOM",t[t.ERROR=11]="ERROR",t[t.LEAVE_ROOM=12]="LEAVE_ROOM",t[t.ROOM_DATA=13]="ROOM_DATA",t[t.ROOM_STATE=14]="ROOM_STATE",t[t.ROOM_STATE_PATCH=15]="ROOM_STATE_PATCH",t[t.ROOM_DATA_SCHEMA=16]="ROOM_DATA_SCHEMA",t[t.ROOM_DATA_BYTES=17]="ROOM_DATA_BYTES",e.ErrorCode=void 0,(r=e.ErrorCode||(e.ErrorCode={}))[r.MATCHMAKE_NO_HANDLER=4210]="MATCHMAKE_NO_HANDLER",r[r.MATCHMAKE_INVALID_CRITERIA=4211]="MATCHMAKE_INVALID_CRITERIA",r[r.MATCHMAKE_INVALID_ROOM_ID=4212]="MATCHMAKE_INVALID_ROOM_ID",r[r.MATCHMAKE_UNHANDLED=4213]="MATCHMAKE_UNHANDLED",r[r.MATCHMAKE_EXPIRED=4214]="MATCHMAKE_EXPIRED",r[r.AUTH_FAILED=4215]="AUTH_FAILED",r[r.APPLICATION_ERROR=4216]="APPLICATION_ERROR"),le;var e,t,r}var ue,de={};function fe(){if(ue)return de;ue=1;const e={};return de.getSerializer=function(t){const r=e[t];if(!r)throw new Error("missing serializer: "+t);return r},de.registerSerializer=function(t,r){e[t]=r},de}var pe,ge={};function me(){return pe||(pe=1,ge.createNanoEvents=()=>({emit(e,...t){let r=this.events[e]||[];for(let n=0,s=r.length;n<s;n++)r[n](...t)},events:{},on(e,t){var r;return(null===(r=this.events[e])||void 0===r?void 0:r.push(t))||(this.events[e]=[t]),()=>{var r;this.events[e]=null===(r=this.events[e])||void 0===r?void 0:r.filter(e=>t!==e)}}})),ge}var ye,ve,be,we,Ee,Oe={},Ie={};function Ae(){if(ve)return Ie;ve=1;var e=te();return Ie.SchemaSerializer=class{setState(e,t){this.decoder.decode(e,t)}getState(){return this.state}patch(e,t){return this.decoder.decode(e,t)}teardown(){this.decoder.root.clearRefs()}handshake(t,r){this.state?(e.Reflection.decode(t,r),this.decoder=new e.Decoder(this.state)):(this.decoder=e.Reflection.decode(t,r),this.state=this.decoder.state)}},Ie.getStateCallbacks=function(t){try{return e.getDecoderStateCallbacks(t.serializer.decoder)}catch(r){return}},Ie}try{be=new TextDecoder}catch(Br){}var Te,Se,_e,xe,Ce,Pe=0,Re={},ke=0,De=0,Ne=[],$e={useRecords:!1,mapsAsObjects:!0};class Me{}const je=new Me;je.name="MessagePack 0xC1";var Le=!1,Be=2;try{new Function("")}catch(Br){Be=1/0}class Fe{constructor(e){e&&(!1===e.useRecords&&void 0===e.mapsAsObjects&&(e.mapsAsObjects=!0),e.sequential&&!1!==e.trusted&&(e.trusted=!0,e.structures||0==e.useRecords||(e.structures=[],e.maxSharedStructures||(e.maxSharedStructures=0))),e.structures?e.structures.sharedLength=e.structures.length:e.getStructures&&((e.structures=[]).uninitialized=!0,e.structures.sharedLength=0),e.int64AsNumber&&(e.int64AsType="number")),Object.assign(this,e)}unpack(e,t){if(we)return gt(()=>(mt(),this?this.unpack(e,t):Fe.prototype.unpack.call($e,e,t)));e.buffer||e.constructor!==ArrayBuffer||(e="undefined"!=typeof Buffer?Buffer.from(e):new Uint8Array(e)),"object"==typeof t?(Ee=t.end||e.length,Pe=t.start||0):(Pe=0,Ee=t>-1?t:e.length),De=0,Se=null,_e=null,we=e;try{Ce=e.dataView||(e.dataView=new DataView(e.buffer,e.byteOffset,e.byteLength))}catch(Br){if(we=null,e instanceof Uint8Array)throw Br;throw new Error("Source must be a Uint8Array or Buffer but was a "+(e&&"object"==typeof e?e.constructor.name:typeof e))}if(this instanceof Fe){if(Re=this,this.structures)return Te=this.structures,Ue();(!Te||Te.length>0)&&(Te=[])}else Re=$e,(!Te||Te.length>0)&&(Te=[]);return Ue()}unpackMultiple(e,t){let r,n=0;try{Le=!0;let s=e.length,i=this?this.unpack(e,s):bt.unpack(e,s);if(!t){for(r=[i];Pe<s;)n=Pe,r.push(Ue());return r}if(!1===t(i,n,Pe))return;for(;Pe<s;)if(n=Pe,!1===t(Ue(),n,Pe))return}catch(Br){throw Br.lastPosition=n,Br.values=r,Br}finally{Le=!1,mt()}}_mergeStructures(e,t){e=e||[],Object.isFrozen(e)&&(e=e.map(e=>e.slice(0)));for(let r=0,n=e.length;r<n;r++){let t=e[r];t&&(t.isShared=!0,r>=32&&(t.highByte=r-32>>5))}e.sharedLength=e.length;for(let r in t||[])if(r>=0){let n=e[r],s=t[r];s&&(n&&((e.restoreStructures||(e.restoreStructures=[]))[r]=n),e[r]=s)}return this.structures=e}decode(e,t){return this.unpack(e,t)}}function Ue(e){try{if(!Re.trusted&&!Le){let e=Te.sharedLength||0;e<Te.length&&(Te.length=e)}let e;if(Re.randomAccessStructure&&we[Pe]<64&&we[Pe],e=ze(),_e&&(Pe=_e.postBundlePosition,_e=null),Le&&(Te.restoreStructures=null),Pe==Ee)Te&&Te.restoreStructures&&Ve(),Te=null,we=null,xe&&(xe=null);else{if(Pe>Ee)throw new Error("Unexpected end of MessagePack data");if(!Le){let t;try{t=JSON.stringify(e,(e,t)=>"bigint"==typeof t?`${t}n`:t).slice(0,100)}catch(Br){t="(JSON view not available "+Br+")"}throw new Error("Data read, but end of buffer not reached "+t)}}return e}catch(Br){throw Te&&Te.restoreStructures&&Ve(),mt(),(Br instanceof RangeError||Br.message.startsWith("Unexpected end of buffer")||Pe>Ee)&&(Br.incomplete=!0),Br}}function Ve(){for(let e in Te.restoreStructures)Te[e]=Te.restoreStructures[e];Te.restoreStructures=null}function ze(){let e=we[Pe++];if(e<160){if(e<128){if(e<64)return e;{let t=Te[63&e]||Re.getStructures&&Je()[63&e];return t?(t.read||(t.read=He(t,63&e)),t.read()):e}}if(e<144){if(e-=128,Re.mapsAsObjects){let t={};for(let r=0;r<e;r++){let e=ct();"__proto__"===e&&(e="__proto_"),t[e]=ze()}return t}{let t=new Map;for(let r=0;r<e;r++)t.set(ze(),ze());return t}}{e-=144;let t=new Array(e);for(let r=0;r<e;r++)t[r]=ze();return Re.freezeData?Object.freeze(t):t}}if(e<192){let t=e-160;if(De>=Pe)return Se.slice(Pe-ke,(Pe+=t)-ke);if(0==De&&Ee<140){let e=t<16?nt(t):rt(t);if(null!=e)return e}return Ke(t)}{let t;switch(e){case 192:return null;case 193:return _e?(t=ze(),t>0?_e[1].slice(_e.position1,_e.position1+=t):_e[0].slice(_e.position0,_e.position0-=t)):je;case 194:return!1;case 195:return!0;case 196:if(t=we[Pe++],void 0===t)throw new Error("Unexpected end of buffer");return it(t);case 197:return t=Ce.getUint16(Pe),Pe+=2,it(t);case 198:return t=Ce.getUint32(Pe),Pe+=4,it(t);case 199:return ot(we[Pe++]);case 200:return t=Ce.getUint16(Pe),Pe+=2,ot(t);case 201:return t=Ce.getUint32(Pe),Pe+=4,ot(t);case 202:if(t=Ce.getFloat32(Pe),Re.useFloat32>2){let e=yt[(127&we[Pe])<<1|we[Pe+1]>>7];return Pe+=4,(e*t+(t>0?.5:-.5)|0)/e}return Pe+=4,t;case 203:return t=Ce.getFloat64(Pe),Pe+=8,t;case 204:return we[Pe++];case 205:return t=Ce.getUint16(Pe),Pe+=2,t;case 206:return t=Ce.getUint32(Pe),Pe+=4,t;case 207:return"number"===Re.int64AsType?(t=4294967296*Ce.getUint32(Pe),t+=Ce.getUint32(Pe+4)):"string"===Re.int64AsType?t=Ce.getBigUint64(Pe).toString():"auto"===Re.int64AsType?(t=Ce.getBigUint64(Pe),t<=BigInt(2)<<BigInt(52)&&(t=Number(t))):t=Ce.getBigUint64(Pe),Pe+=8,t;case 208:return Ce.getInt8(Pe++);case 209:return t=Ce.getInt16(Pe),Pe+=2,t;case 210:return t=Ce.getInt32(Pe),Pe+=4,t;case 211:return"number"===Re.int64AsType?(t=4294967296*Ce.getInt32(Pe),t+=Ce.getUint32(Pe+4)):"string"===Re.int64AsType?t=Ce.getBigInt64(Pe).toString():"auto"===Re.int64AsType?(t=Ce.getBigInt64(Pe),t>=BigInt(-2)<<BigInt(52)&&t<=BigInt(2)<<BigInt(52)&&(t=Number(t))):t=Ce.getBigInt64(Pe),Pe+=8,t;case 212:if(t=we[Pe++],114==t)return ht(63&we[Pe++]);{let e=Ne[t];if(e)return e.read?(Pe++,e.read(ze())):e.noBuffer?(Pe++,e()):e(we.subarray(Pe,++Pe));throw new Error("Unknown extension "+t)}case 213:return t=we[Pe],114==t?(Pe++,ht(63&we[Pe++],we[Pe++])):ot(2);case 214:return ot(4);case 215:return ot(8);case 216:return ot(16);case 217:return t=we[Pe++],De>=Pe?Se.slice(Pe-ke,(Pe+=t)-ke):Ye(t);case 218:return t=Ce.getUint16(Pe),De>=(Pe+=2)?Se.slice(Pe-ke,(Pe+=t)-ke):Ge(t);case 219:return t=Ce.getUint32(Pe),De>=(Pe+=4)?Se.slice(Pe-ke,(Pe+=t)-ke):Xe(t);case 220:return t=Ce.getUint16(Pe),Pe+=2,Qe(t);case 221:return t=Ce.getUint32(Pe),Pe+=4,Qe(t);case 222:return t=Ce.getUint16(Pe),Pe+=2,et(t);case 223:return t=Ce.getUint32(Pe),Pe+=4,et(t);default:if(e>=224)return e-256;if(void 0===e){let e=new Error("Unexpected end of MessagePack data");throw e.incomplete=!0,e}throw new Error("Unknown MessagePack token "+e)}}}const We=/^[a-zA-Z_$][a-zA-Z\d_$]*$/;function He(e,t){function r(){if(r.count++>Be){let r=e.read=new Function("r","return function(){return "+(Re.freezeData?"Object.freeze":"")+"({"+e.map(e=>"__proto__"===e?"__proto_:r()":We.test(e)?e+":r()":"["+JSON.stringify(e)+"]:r()").join(",")+"})}")(ze);return 0===e.highByte&&(e.read=qe(t,e.read)),r()}let n={};for(let t=0,r=e.length;t<r;t++){let r=e[t];"__proto__"===r&&(r="__proto_"),n[r]=ze()}return Re.freezeData?Object.freeze(n):n}return r.count=0,0===e.highByte?qe(t,r):r}const qe=(e,t)=>function(){let r=we[Pe++];if(0===r)return t();let n=e<32?-(e+(r<<5)):e+(r<<5),s=Te[n]||Je()[n];if(!s)throw new Error("Record id is not defined for "+n);return s.read||(s.read=He(s,e)),s.read()};function Je(){let e=gt(()=>(we=null,Re.getStructures()));return Te=Re._mergeStructures(e,Te)}var Ke=Ze,Ye=Ze,Ge=Ze,Xe=Ze;function Ze(e){let t;if(e<16&&(t=nt(e)))return t;if(e>64&&be)return be.decode(we.subarray(Pe,Pe+=e));const r=Pe+e,n=[];for(t="";Pe<r;){const e=we[Pe++];if(128&e)if(192==(224&e)){const t=63&we[Pe++];n.push((31&e)<<6|t)}else if(224==(240&e)){const t=63&we[Pe++],r=63&we[Pe++];n.push((31&e)<<12|t<<6|r)}else if(240==(248&e)){let t=(7&e)<<18|(63&we[Pe++])<<12|(63&we[Pe++])<<6|63&we[Pe++];t>65535&&(t-=65536,n.push(t>>>10&1023|55296),t=56320|1023&t),n.push(t)}else n.push(e);else n.push(e);n.length>=4096&&(t+=tt.apply(String,n),n.length=0)}return n.length>0&&(t+=tt.apply(String,n)),t}function Qe(e){let t=new Array(e);for(let r=0;r<e;r++)t[r]=ze();return Re.freezeData?Object.freeze(t):t}function et(e){if(Re.mapsAsObjects){let t={};for(let r=0;r<e;r++){let e=ct();"__proto__"===e&&(e="__proto_"),t[e]=ze()}return t}{let t=new Map;for(let r=0;r<e;r++)t.set(ze(),ze());return t}}var tt=String.fromCharCode;function rt(e){let t=Pe,r=new Array(e);for(let n=0;n<e;n++){const e=we[Pe++];if((128&e)>0)return void(Pe=t);r[n]=e}return tt.apply(String,r)}function nt(e){if(e<4){if(e<2){if(0===e)return"";{let e=we[Pe++];return(128&e)>1?void(Pe-=1):tt(e)}}{let t=we[Pe++],r=we[Pe++];if((128&t)>0||(128&r)>0)return void(Pe-=2);if(e<3)return tt(t,r);let n=we[Pe++];return(128&n)>0?void(Pe-=3):tt(t,r,n)}}{let t=we[Pe++],r=we[Pe++],n=we[Pe++],s=we[Pe++];if((128&t)>0||(128&r)>0||(128&n)>0||(128&s)>0)return void(Pe-=4);if(e<6){if(4===e)return tt(t,r,n,s);{let e=we[Pe++];return(128&e)>0?void(Pe-=5):tt(t,r,n,s,e)}}if(e<8){let i=we[Pe++],o=we[Pe++];if((128&i)>0||(128&o)>0)return void(Pe-=6);if(e<7)return tt(t,r,n,s,i,o);let a=we[Pe++];return(128&a)>0?void(Pe-=7):tt(t,r,n,s,i,o,a)}{let i=we[Pe++],o=we[Pe++],a=we[Pe++],c=we[Pe++];if((128&i)>0||(128&o)>0||(128&a)>0||(128&c)>0)return void(Pe-=8);if(e<10){if(8===e)return tt(t,r,n,s,i,o,a,c);{let e=we[Pe++];return(128&e)>0?void(Pe-=9):tt(t,r,n,s,i,o,a,c,e)}}if(e<12){let l=we[Pe++],h=we[Pe++];if((128&l)>0||(128&h)>0)return void(Pe-=10);if(e<11)return tt(t,r,n,s,i,o,a,c,l,h);let u=we[Pe++];return(128&u)>0?void(Pe-=11):tt(t,r,n,s,i,o,a,c,l,h,u)}{let l=we[Pe++],h=we[Pe++],u=we[Pe++],d=we[Pe++];if((128&l)>0||(128&h)>0||(128&u)>0||(128&d)>0)return void(Pe-=12);if(e<14){if(12===e)return tt(t,r,n,s,i,o,a,c,l,h,u,d);{let e=we[Pe++];return(128&e)>0?void(Pe-=13):tt(t,r,n,s,i,o,a,c,l,h,u,d,e)}}{let f=we[Pe++],p=we[Pe++];if((128&f)>0||(128&p)>0)return void(Pe-=14);if(e<15)return tt(t,r,n,s,i,o,a,c,l,h,u,d,f,p);let g=we[Pe++];return(128&g)>0?void(Pe-=15):tt(t,r,n,s,i,o,a,c,l,h,u,d,f,p,g)}}}}}function st(){let e,t=we[Pe++];if(t<192)e=t-160;else switch(t){case 217:e=we[Pe++];break;case 218:e=Ce.getUint16(Pe),Pe+=2;break;case 219:e=Ce.getUint32(Pe),Pe+=4;break;default:throw new Error("Expected string")}return Ze(e)}function it(e){return Re.copyBuffers?Uint8Array.prototype.slice.call(we,Pe,Pe+=e):we.subarray(Pe,Pe+=e)}function ot(e){let t=we[Pe++];if(Ne[t]){let r;return Ne[t](we.subarray(Pe,r=Pe+=e),e=>{Pe=e;try{return ze()}finally{Pe=r}})}throw new Error("Unknown extension type "+t)}var at=new Array(4096);function ct(){let e=we[Pe++];if(!(e>=160&&e<192))return Pe--,lt(ze());if(e-=160,De>=Pe)return Se.slice(Pe-ke,(Pe+=e)-ke);if(!(0==De&&Ee<180))return Ke(e);let t,r=4095&(e<<5^(e>1?Ce.getUint16(Pe):e>0?we[Pe]:0)),n=at[r],s=Pe,i=Pe+e-3,o=0;if(n&&n.bytes==e){for(;s<i;){if(t=Ce.getUint32(s),t!=n[o++]){s=1879048192;break}s+=4}for(i+=3;s<i;)if(t=we[s++],t!=n[o++]){s=1879048192;break}if(s===i)return Pe=s,n.string;i-=3,s=Pe}for(n=[],at[r]=n,n.bytes=e;s<i;)t=Ce.getUint32(s),n.push(t),s+=4;for(i+=3;s<i;)t=we[s++],n.push(t);let a=e<16?nt(e):rt(e);return n.string=null!=a?a:Ke(e)}function lt(e){if("string"==typeof e)return e;if("number"==typeof e||"boolean"==typeof e||"bigint"==typeof e)return e.toString();if(null==e)return e+"";if(Re.allowArraysInMapKeys&&Array.isArray(e)&&e.flat().every(e=>["string","number","boolean","bigint"].includes(typeof e)))return e.flat().toString();throw new Error("Invalid property type for record: "+typeof e)}const ht=(e,t)=>{let r=ze().map(lt),n=e;void 0!==t&&(e=e<32?-((t<<5)+e):(t<<5)+e,r.highByte=t);let s=Te[e];return s&&(s.isShared||Le)&&((Te.restoreStructures||(Te.restoreStructures=[]))[e]=s),Te[e]=r,r.read=He(r,n),r.read()};Ne[0]=()=>{},Ne[0].noBuffer=!0,Ne[66]=e=>{let t=e.length,r=BigInt(128&e[0]?e[0]-256:e[0]);for(let n=1;n<t;n++)r<<=BigInt(8),r+=BigInt(e[n]);return r};let ut={Error:Error,TypeError:TypeError,ReferenceError:ReferenceError};Ne[101]=()=>{let e=ze();return(ut[e[0]]||Error)(e[1],{cause:e[2]})},Ne[105]=e=>{if(!1===Re.structuredClone)throw new Error("Structured clone extension is disabled");let t=Ce.getUint32(Pe-4);xe||(xe=new Map);let r,n=we[Pe];r=n>=144&&n<160||220==n||221==n?[]:{};let s={target:r};xe.set(t,s);let i=ze();return s.used?Object.assign(r,i):(s.target=i,i)},Ne[112]=e=>{if(!1===Re.structuredClone)throw new Error("Structured clone extension is disabled");let t=Ce.getUint32(Pe-4),r=xe.get(t);return r.used=!0,r.target},Ne[115]=()=>new Set(ze());const dt=["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64","BigInt64","BigUint64"].map(e=>e+"Array");let ft="object"==typeof globalThis?globalThis:window;Ne[116]=e=>{let t=e[0],r=dt[t];if(!r){if(16===t){let t=new ArrayBuffer(e.length-1);return new Uint8Array(t).set(e.subarray(1)),t}throw new Error("Could not find typed array for code "+t)}return new ft[r](Uint8Array.prototype.slice.call(e,1).buffer)},Ne[120]=()=>{let e=ze();return new RegExp(e[0],e[1])};const pt=[];function gt(e){let t=Ee,r=Pe,n=ke,s=De,i=Se,o=xe,a=_e,c=new Uint8Array(we.slice(0,Ee)),l=Te,h=Te.slice(0,Te.length),u=Re,d=Le,f=e();return Ee=t,Pe=r,ke=n,De=s,Se=i,xe=o,_e=a,we=c,Le=d,(Te=l).splice(0,Te.length,...h),Re=u,Ce=new DataView(we.buffer,we.byteOffset,we.byteLength),f}function mt(){we=null,xe=null,Te=null}Ne[98]=e=>{let t=(e[0]<<24)+(e[1]<<16)+(e[2]<<8)+e[3],r=Pe;return Pe+=t-e.length,_e=pt,(_e=[st(),st()]).position0=0,_e.position1=0,_e.postBundlePosition=Pe,Pe=r,ze()},Ne[255]=e=>4==e.length?new Date(1e3*(16777216*e[0]+(e[1]<<16)+(e[2]<<8)+e[3])):8==e.length?new Date(((e[0]<<22)+(e[1]<<14)+(e[2]<<6)+(e[3]>>2))/1e6+1e3*(4294967296*(3&e[3])+16777216*e[4]+(e[5]<<16)+(e[6]<<8)+e[7])):12==e.length?new Date(((e[0]<<24)+(e[1]<<16)+(e[2]<<8)+e[3])/1e6+1e3*((128&e[4]?-281474976710656:0)+1099511627776*e[6]+4294967296*e[7]+16777216*e[8]+(e[9]<<16)+(e[10]<<8)+e[11])):new Date("invalid");const yt=new Array(147);for(let Fr=0;Fr<256;Fr++)yt[Fr]=+("1e"+Math.floor(45.15-.30103*Fr));const vt=Fe;var bt=new Fe({useRecords:!1});const wt=bt.unpack,Et=bt.unpackMultiple,Ot=bt.unpack,It={NEVER:0,ALWAYS:1,DECIMAL_ROUND:3,DECIMAL_FIT:4};let At,Tt,St,_t=new Float32Array(1),xt=new Uint8Array(_t.buffer,0,4);try{At=new TextEncoder}catch(Br){}const Ct="undefined"!=typeof Buffer,Pt=Ct?function(e){return Buffer.allocUnsafeSlow(e)}:Uint8Array,Rt=Ct?Buffer:Uint8Array,kt=Ct?4294967296:2144337920;let Dt,Nt,$t,Mt,jt=0,Lt=null;const Bt=/[\u0080-\uFFFF]/,Ft=Symbol("record-id");class Ut extends Fe{constructor(e){let t,r,n,s;super(e),this.offset=0;let i=Rt.prototype.utf8Write?function(e,t){return Dt.utf8Write(e,t,Dt.byteLength-t)}:!(!At||!At.encodeInto)&&function(e,t){return At.encodeInto(e,Dt.subarray(t)).written},o=this;e||(e={});let a=e&&e.sequential,c=e.structures||e.saveStructures,l=e.maxSharedStructures;if(null==l&&(l=c?32:0),l>8160)throw new Error("Maximum maxSharedStructure is 8160");e.structuredClone&&null==e.moreTypes&&(this.moreTypes=!0);let h=e.maxOwnStructures;null==h&&(h=c?32:64),this.structures||0==e.useRecords||(this.structures=[]);let u=l>32||h+l>64,d=l+64,f=l+h+64;if(f>8256)throw new Error("Maximum maxSharedStructure + maxOwnStructure is 8192");let p=[],g=0,m=0;this.pack=this.encode=function(e,i){if(Dt||(Dt=new Pt(8192),$t=Dt.dataView||(Dt.dataView=new DataView(Dt.buffer,0,8192)),jt=0),Mt=Dt.length-10,Mt-jt<2048?(Dt=new Pt(Dt.length),$t=Dt.dataView||(Dt.dataView=new DataView(Dt.buffer,0,Dt.length)),Mt=Dt.length-10,jt=0):jt=jt+7&2147483640,t=jt,i&rr&&(jt+=255&i),s=o.structuredClone?new Map:null,o.bundleStrings&&"string"!=typeof e?(Lt=[],Lt.size=1/0):Lt=null,n=o.structures,n){n.uninitialized&&(n=o._mergeStructures(o.getStructures()));let e=n.sharedLength||0;if(e>l)throw new Error("Shared structures is larger than maximum shared structures, try increasing maxSharedStructures to "+n.sharedLength);if(!n.transitions){n.transitions=Object.create(null);for(let t=0;t<e;t++){let e=n[t];if(!e)continue;let r,s=n.transitions;for(let t=0,n=e.length;t<n;t++){let n=e[t];r=s[n],r||(r=s[n]=Object.create(null)),s=r}s[Ft]=t+64}this.lastNamedStructuresLength=e}a||(n.nextId=e+64)}let c;r&&(r=!1);try{o.randomAccessStructure&&e&&e.constructor&&e.constructor===Object?_(e):b(e);let r=Lt;if(Lt&&Ht(t,b,0),s&&s.idsToInsert){let e=s.idsToInsert.sort((e,t)=>e.offset>t.offset?1:-1),n=e.length,i=-1;for(;r&&n>0;){let s=e[--n].offset+t;s<r.stringsPosition+t&&-1===i&&(i=0),s>r.position+t?i>=0&&(i+=6):(i>=0&&($t.setUint32(r.position+t,$t.getUint32(r.position+t)+i),i=-1),r=r.previous,n++)}i>=0&&r&&$t.setUint32(r.position+t,$t.getUint32(r.position+t)+i),jt+=6*e.length,jt>Mt&&A(jt),o.offset=jt;let a=function(e,t){let r,n=6*t.length,s=e.length-n;for(;r=t.pop();){let t=r.offset,i=r.id;e.copyWithin(t+n,t,s),n-=6;let o=t+n;e[o++]=214,e[o++]=105,e[o++]=i>>24,e[o++]=i>>16&255,e[o++]=i>>8&255,e[o++]=255&i,s=t}return e}(Dt.subarray(t,jt),e);return s=null,a}return o.offset=jt,i&er?(Dt.start=t,Dt.end=jt,Dt):Dt.subarray(t,jt)}catch(Br){throw c=Br,Br}finally{if(n&&(y(),r&&o.saveStructures)){let r=n.sharedLength||0,s=Dt.subarray(t,jt),a=function(e,t){return e.isCompatible=e=>{let r=!e||(t.lastNamedStructuresLength||0)===e.length;return r||t._mergeStructures(e),r},e}(n,o);if(!c)return!1===o.saveStructures(a,a.isCompatible)?o.pack(e,i):(o.lastNamedStructuresLength=r,Dt.length>1073741824&&(Dt=null),s)}Dt.length>1073741824&&(Dt=null),i&tr&&(jt=t)}};const y=()=>{m<10&&m++;let e=n.sharedLength||0;if(n.length>e&&!a&&(n.length=e),g>1e4)n.transitions=null,m=0,g=0,p.length>0&&(p=[]);else if(p.length>0&&!a){for(let e=0,t=p.length;e<t;e++)p[e][Ft]=0;p=[]}},v=e=>{var t=e.length;t<16?Dt[jt++]=144|t:t<65536?(Dt[jt++]=220,Dt[jt++]=t>>8,Dt[jt++]=255&t):(Dt[jt++]=221,$t.setUint32(jt,t),jt+=4);for(let r=0;r<t;r++)b(e[r])},b=e=>{jt>Mt&&(Dt=A(jt));var r,n=typeof e;if("string"===n){let n,s=e.length;if(Lt&&s>=4&&s<4096){if((Lt.size+=s)>21760){let e,r,n=(Lt[0]?3*Lt[0].length+Lt[1].length:0)+10;jt+n>Mt&&(Dt=A(jt+n)),Lt.position?(r=Lt,Dt[jt]=200,jt+=3,Dt[jt++]=98,e=jt-t,jt+=4,Ht(t,b,0),$t.setUint16(e+t-3,jt-t-e)):(Dt[jt++]=214,Dt[jt++]=98,e=jt-t,jt+=4),Lt=["",""],Lt.previous=r,Lt.size=0,Lt.position=e}let r=Bt.test(e);return Lt[r?0:1]+=e,Dt[jt++]=193,void b(r?-s:s)}n=s<32?1:s<256?2:s<65536?3:5;let o=3*s;if(jt+o>Mt&&(Dt=A(jt+o)),s<64||!i){let t,i,o,a=jt+n;for(t=0;t<s;t++)i=e.charCodeAt(t),i<128?Dt[a++]=i:i<2048?(Dt[a++]=i>>6|192,Dt[a++]=63&i|128):55296==(64512&i)&&56320==(64512&(o=e.charCodeAt(t+1)))?(i=65536+((1023&i)<<10)+(1023&o),t++,Dt[a++]=i>>18|240,Dt[a++]=i>>12&63|128,Dt[a++]=i>>6&63|128,Dt[a++]=63&i|128):(Dt[a++]=i>>12|224,Dt[a++]=i>>6&63|128,Dt[a++]=63&i|128);r=a-jt-n}else r=i(e,jt+n);r<32?Dt[jt++]=160|r:r<256?(n<2&&Dt.copyWithin(jt+2,jt+1,jt+1+r),Dt[jt++]=217,Dt[jt++]=r):r<65536?(n<3&&Dt.copyWithin(jt+3,jt+2,jt+2+r),Dt[jt++]=218,Dt[jt++]=r>>8,Dt[jt++]=255&r):(n<5&&Dt.copyWithin(jt+5,jt+3,jt+3+r),Dt[jt++]=219,$t.setUint32(jt,r),jt+=4),jt+=r}else if("number"===n)if(e>>>0===e)e<32||e<128&&!1===this.useRecords||e<64&&!this.randomAccessStructure?Dt[jt++]=e:e<256?(Dt[jt++]=204,Dt[jt++]=e):e<65536?(Dt[jt++]=205,Dt[jt++]=e>>8,Dt[jt++]=255&e):(Dt[jt++]=206,$t.setUint32(jt,e),jt+=4);else if((0|e)===e)e>=-32?Dt[jt++]=256+e:e>=-128?(Dt[jt++]=208,Dt[jt++]=e+256):e>=-32768?(Dt[jt++]=209,$t.setInt16(jt,e),jt+=2):(Dt[jt++]=210,$t.setInt32(jt,e),jt+=4);else{let t;if((t=this.useFloat32)>0&&e<4294967296&&e>=-2147483648){let r;if(Dt[jt++]=202,$t.setFloat32(jt,e),t<4||(0|(r=e*yt[(127&Dt[jt])<<1|Dt[jt+1]>>7]))===r)return void(jt+=4);jt--}Dt[jt++]=203,$t.setFloat64(jt,e),jt+=8}else if("object"===n||"function"===n)if(e){if(s){let r=s.get(e);if(r){if(!r.id){let e=s.idsToInsert||(s.idsToInsert=[]);r.id=e.push(r)}return Dt[jt++]=214,Dt[jt++]=112,$t.setUint32(jt,r.id),void(jt+=4)}s.set(e,{offset:jt-t})}let i=e.constructor;if(i===Object)I(e);else if(i===Array)v(e);else if(i===Map)if(this.mapAsEmptyObject)Dt[jt++]=128;else{(r=e.size)<16?Dt[jt++]=128|r:r<65536?(Dt[jt++]=222,Dt[jt++]=r>>8,Dt[jt++]=255&r):(Dt[jt++]=223,$t.setUint32(jt,r),jt+=4);for(let[t,r]of e)b(t),b(r)}else{for(let t=0,r=Tt.length;t<r;t++)if(e instanceof St[t]){let r=Tt[t];if(r.write){r.type&&(Dt[jt++]=212,Dt[jt++]=r.type,Dt[jt++]=0);let t=r.write.call(this,e);return void(t===e?Array.isArray(e)?v(e):I(e):b(t))}let n,s=Dt,i=$t,o=jt;Dt=null;try{n=r.pack.call(this,e,e=>(Dt=s,s=null,jt+=e,jt>Mt&&A(jt),{target:Dt,targetView:$t,position:jt-e}),b)}finally{s&&(Dt=s,$t=i,jt=o,Mt=Dt.length-10)}return void(n&&(n.length+jt>Mt&&A(n.length+jt),jt=Wt(n,Dt,jt,r.type)))}if(Array.isArray(e))v(e);else{if(e.toJSON){const t=e.toJSON();if(t!==e)return b(t)}if("function"===n)return b(this.writeFunction&&this.writeFunction(e));I(e)}}}else Dt[jt++]=192;else if("boolean"===n)Dt[jt++]=e?195:194;else if("bigint"===n){if(e<BigInt(1)<<BigInt(63)&&e>=-(BigInt(1)<<BigInt(63)))Dt[jt++]=211,$t.setBigInt64(jt,e);else if(e<BigInt(1)<<BigInt(64)&&e>0)Dt[jt++]=207,$t.setBigUint64(jt,e);else{if(!this.largeBigIntToFloat){if(this.largeBigIntToString)return b(e.toString());if(this.useBigIntExtension&&e<BigInt(2)**BigInt(1023)&&e>-(BigInt(2)**BigInt(1023))){Dt[jt++]=199,jt++,Dt[jt++]=66;let t,r=[];do{let n=e&BigInt(255);t=(n&BigInt(128))===(e<BigInt(0)?BigInt(128):BigInt(0)),r.push(n),e>>=BigInt(8)}while(e!==BigInt(0)&&e!==BigInt(-1)||!t);Dt[jt-2]=r.length;for(let e=r.length;e>0;)Dt[jt++]=Number(r[--e]);return}throw new RangeError(e+" was too large to fit in MessagePack 64-bit integer format, use useBigIntExtension, or set largeBigIntToFloat to convert to float-64, or set largeBigIntToString to convert to string")}Dt[jt++]=203,$t.setFloat64(jt,Number(e))}jt+=8}else{if("undefined"!==n)throw new Error("Unknown type: "+n);this.encodeUndefinedAsNil?Dt[jt++]=192:(Dt[jt++]=212,Dt[jt++]=0,Dt[jt++]=0)}},w=this.variableMapSize||this.coercibleKeyAsNumber||this.skipValues?e=>{let t;if(this.skipValues){t=[];for(let r in e)"function"==typeof e.hasOwnProperty&&!e.hasOwnProperty(r)||this.skipValues.includes(e[r])||t.push(r)}else t=Object.keys(e);let r,n=t.length;if(n<16?Dt[jt++]=128|n:n<65536?(Dt[jt++]=222,Dt[jt++]=n>>8,Dt[jt++]=255&n):(Dt[jt++]=223,$t.setUint32(jt,n),jt+=4),this.coercibleKeyAsNumber)for(let s=0;s<n;s++){r=t[s];let n=Number(r);b(isNaN(n)?r:n),b(e[r])}else for(let s=0;s<n;s++)b(r=t[s]),b(e[r])}:e=>{Dt[jt++]=222;let r=jt-t;jt+=2;let n=0;for(let t in e)("function"!=typeof e.hasOwnProperty||e.hasOwnProperty(t))&&(b(t),b(e[t]),n++);if(n>65535)throw new Error('Object is too large to serialize with fast 16-bit map size, use the "variableMapSize" option to serialize this object');Dt[r+++t]=n>>8,Dt[r+t]=255&n},E=!1===this.useRecords?w:e.progressiveRecords&&!u?e=>{let r,s,i=n.transitions||(n.transitions=Object.create(null)),o=jt++-t;for(let a in e)if("function"!=typeof e.hasOwnProperty||e.hasOwnProperty(a)){if(r=i[a],r)i=r;else{let c=Object.keys(e),l=i;i=n.transitions;let h=0;for(let e=0,t=c.length;e<t;e++){let t=c[e];r=i[t],r||(r=i[t]=Object.create(null),h++),i=r}o+t+1==jt?(jt--,T(i,c,h)):S(i,c,o,h),s=!0,i=l[a]}b(e[a])}if(!s){let r=i[Ft];r?Dt[o+t]=r:S(i,Object.keys(e),o,0)}}:e=>{let t,r=n.transitions||(n.transitions=Object.create(null)),s=0;for(let n in e)("function"!=typeof e.hasOwnProperty||e.hasOwnProperty(n))&&(t=r[n],t||(t=r[n]=Object.create(null),s++),r=t);let i=r[Ft];i?i>=96&&u?(Dt[jt++]=96+(31&(i-=96)),Dt[jt++]=i>>5):Dt[jt++]=i:T(r,r.__keys__||Object.keys(e),s);for(let n in e)("function"!=typeof e.hasOwnProperty||e.hasOwnProperty(n))&&b(e[n])},O="function"==typeof this.useRecords&&this.useRecords,I=O?e=>{O(e)?E(e):w(e)}:E,A=e=>{let r;if(e>16777216){if(e-t>kt)throw new Error("Packed buffer would be larger than maximum buffer size");r=Math.min(kt,4096*Math.round(Math.max((e-t)*(e>67108864?1.25:2),4194304)/4096))}else r=1+(Math.max(e-t<<2,Dt.length-1)>>12)<<12;let n=new Pt(r);return $t=n.dataView||(n.dataView=new DataView(n.buffer,0,r)),e=Math.min(e,Dt.length),Dt.copy?Dt.copy(n,0,t,e):n.set(Dt.slice(t,e)),jt-=t,t=0,Mt=n.length-10,Dt=n},T=(e,t,s)=>{let i=n.nextId;i||(i=64),i<d&&this.shouldShareStructure&&!this.shouldShareStructure(t)?(i=n.nextOwnId,i<f||(i=d),n.nextOwnId=i+1):(i>=f&&(i=d),n.nextId=i+1);let o=t.highByte=i>=96&&u?i-96>>5:-1;e[Ft]=i,e.__keys__=t,n[i-64]=t,i<d?(t.isShared=!0,n.sharedLength=i-63,r=!0,o>=0?(Dt[jt++]=96+(31&i),Dt[jt++]=o):Dt[jt++]=i):(o>=0?(Dt[jt++]=213,Dt[jt++]=114,Dt[jt++]=96+(31&i),Dt[jt++]=o):(Dt[jt++]=212,Dt[jt++]=114,Dt[jt++]=i),s&&(g+=m*s),p.length>=h&&(p.shift()[Ft]=0),p.push(e),b(t))},S=(e,r,n,s)=>{let i=Dt,o=jt,a=Mt,c=t;Dt=Nt,jt=0,t=0,Dt||(Nt=Dt=new Pt(8192)),Mt=Dt.length-10,T(e,r,s),Nt=Dt;let l=jt;if(Dt=i,jt=o,Mt=a,t=c,l>1){let e=jt+l-1;e>Mt&&A(e);let r=n+t;Dt.copyWithin(r+l,r+1,jt),Dt.set(Nt.slice(0,l),r),jt=e}else Dt[n+t]=Nt[0]},_=e=>{let s=(void 0)(e,Dt,t,jt,n,A,(e,t,n)=>{if(n)return r=!0;jt=t;let s=Dt;return b(e),y(),s!==Dt?{position:jt,targetView:$t,target:Dt}:jt},this);if(0===s)return I(e);jt=s}}useBuffer(e){Dt=e,Dt.dataView||(Dt.dataView=new DataView(Dt.buffer,Dt.byteOffset,Dt.byteLength)),jt=0}set position(e){jt=e}get position(){return jt}set buffer(e){Dt=e}get buffer(){return Dt}clearSharedData(){this.structures&&(this.structures=[]),this.typedStructs&&(this.typedStructs=[])}}function Vt(e,t,r,n){let s=e.byteLength;if(s+1<256){var{target:i,position:o}=r(4+s);i[o++]=199,i[o++]=s+1}else if(s+1<65536){var{target:i,position:o}=r(5+s);i[o++]=200,i[o++]=s+1>>8,i[o++]=s+1&255}else{var{target:i,position:o,targetView:a}=r(7+s);i[o++]=201,a.setUint32(o,s+1),o+=4}i[o++]=116,i[o++]=t,e.buffer||(e=new Uint8Array(e)),i.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),o)}function zt(e,t){let r=e.byteLength;var n,s;if(r<256){var{target:n,position:s}=t(r+2);n[s++]=196,n[s++]=r}else if(r<65536){var{target:n,position:s}=t(r+3);n[s++]=197,n[s++]=r>>8,n[s++]=255&r}else{var{target:n,position:s,targetView:i}=t(r+5);n[s++]=198,i.setUint32(s,r),s+=4}n.set(e,s)}function Wt(e,t,r,n){let s=e.length;switch(s){case 1:t[r++]=212;break;case 2:t[r++]=213;break;case 4:t[r++]=214;break;case 8:t[r++]=215;break;case 16:t[r++]=216;break;default:s<256?(t[r++]=199,t[r++]=s):s<65536?(t[r++]=200,t[r++]=s>>8,t[r++]=255&s):(t[r++]=201,t[r++]=s>>24,t[r++]=s>>16&255,t[r++]=s>>8&255,t[r++]=255&s)}return t[r++]=n,t.set(e,r),r+s}function Ht(e,t,r){if(Lt.length>0){$t.setUint32(Lt.position+e,jt+r-Lt.position-e),Lt.stringsPosition=jt-e;let n=Lt;Lt=null,t(n[0]),t(n[1])}}St=[Date,Set,Error,RegExp,ArrayBuffer,Object.getPrototypeOf(Uint8Array.prototype).constructor,Me],Tt=[{pack(e,t,r){let n=e.getTime()/1e3;if((this.useTimestamp32||0===e.getMilliseconds())&&n>=0&&n<4294967296){let{target:e,targetView:r,position:s}=t(6);e[s++]=214,e[s++]=255,r.setUint32(s,n)}else if(n>0&&n<4294967296){let{target:r,targetView:s,position:i}=t(10);r[i++]=215,r[i++]=255,s.setUint32(i,4e6*e.getMilliseconds()+(n/1e3/4294967296|0)),s.setUint32(i+4,n)}else if(isNaN(n)){if(this.onInvalidDate)return t(0),r(this.onInvalidDate());let{target:e,targetView:n,position:s}=t(3);e[s++]=212,e[s++]=255,e[s++]=255}else{let{target:r,targetView:s,position:i}=t(15);r[i++]=199,r[i++]=12,r[i++]=255,s.setUint32(i,1e6*e.getMilliseconds()),s.setBigInt64(i+4,BigInt(Math.floor(n)))}}},{pack(e,t,r){if(this.setAsEmptyObject)return t(0),r({});let n=Array.from(e),{target:s,position:i}=t(this.moreTypes?3:0);this.moreTypes&&(s[i++]=212,s[i++]=115,s[i++]=0),r(n)}},{pack(e,t,r){let{target:n,position:s}=t(this.moreTypes?3:0);this.moreTypes&&(n[s++]=212,n[s++]=101,n[s++]=0),r([e.name,e.message,e.cause])}},{pack(e,t,r){let{target:n,position:s}=t(this.moreTypes?3:0);this.moreTypes&&(n[s++]=212,n[s++]=120,n[s++]=0),r([e.source,e.flags])}},{pack(e,t){this.moreTypes?Vt(e,16,t):zt(Ct?Buffer.from(e):new Uint8Array(e),t)}},{pack(e,t){let r=e.constructor;r!==Rt&&this.moreTypes?Vt(e,dt.indexOf(r.name),t):zt(e,t)}},{pack(e,t){let{target:r,position:n}=t(1);r[n]=193}}];let qt=new Ut({useRecords:!1});const Jt=qt.pack,Kt=qt.pack,Yt=Ut,{NEVER:Gt,ALWAYS:Xt,DECIMAL_ROUND:Zt,DECIMAL_FIT:Qt}=It,er=512,tr=1024,rr=2048,nr=n(Object.freeze(Object.defineProperty({__proto__:null,ALWAYS:Xt,C1:je,DECIMAL_FIT:Qt,DECIMAL_ROUND:Zt,Decoder:vt,Encoder:Yt,FLOAT32_OPTIONS:It,NEVER:Gt,Packr:Ut,RESERVE_START_SPACE:rr,RESET_BUFFER_MODE:tr,REUSE_BUFFER_MODE:er,Unpackr:Fe,addExtension:function(e){if(e.Class){if(!e.pack&&!e.write)throw new Error("Extension has no pack or write function");if(e.pack&&!e.type)throw new Error("Extension has no type (numeric code to identify the extension)");St.unshift(e.Class),Tt.unshift(e)}!function(e){e.unpack?Ne[e.type]=e.unpack:Ne[e.type]=e}(e)},clearSource:mt,decode:Ot,decodeIter:function(e,t={}){if(!e||"object"!=typeof e)throw new Error("first argument must be an Iterable, Async Iterable, Iterator, Async Iterator, or a promise");const r=new Fe(t);let n;const s=e=>{let t;n&&(e=Buffer.concat([n,e]),n=void 0);try{t=r.unpackMultiple(e)}catch(s){if(!s.incomplete)throw s;n=e.slice(s.lastPosition),t=s.values}return t};return"function"==typeof e[Symbol.iterator]?function*(){for(const t of e)yield*s(t)}():"function"==typeof e[Symbol.asyncIterator]?async function*(){for await(const t of e)yield*s(t)}():void 0},encode:Kt,encodeIter:function(e,t={}){if(e&&"object"==typeof e){if("function"==typeof e[Symbol.iterator])return function*(e,t){const r=new Ut(t);for(const n of e)yield r.pack(n)}(e,t);if("function"==typeof e.then||"function"==typeof e[Symbol.asyncIterator])return async function*(e,t){const r=new Ut(t);for await(const n of e)yield r.pack(n)}(e,t);throw new Error("first argument must be an Iterable, Async Iterable, Iterator, Async Iterator, or a Promise")}throw new Error("first argument must be an Iterable, Async Iterable, or a Promise for an Async Iterable")},isNativeAccelerationEnabled:!1,mapsAsObjects:!0,pack:Jt,roundFloat32:function(e){_t[0]=e;let t=yt[(127&xt[3])<<1|xt[2]>>7];return(t*e+(e>0?.5:-.5)|0)/t},unpack:wt,unpackMultiple:Et,useRecords:!1},Symbol.toStringTag,{value:"Module"})));var sr;function ir(){if(sr)return X;sr=1;var e=ae(),t=he(),r=fe(),n=me(),s=function(){if(ye)return Oe;ye=1;class e{constructor(){this.handlers=[]}register(e,t=!1){return this.handlers.push(e),this}invoke(...e){this.handlers.forEach(t=>t.apply(this,e))}invokeAsync(...e){return Promise.all(this.handlers.map(t=>t.apply(this,e)))}remove(e){const t=this.handlers.indexOf(e);this.handlers[t]=this.handlers[this.handlers.length-1],this.handlers.pop()}clear(){this.handlers=[]}}return Oe.EventEmitter=e,Oe.createSignal=function(){const t=new e;function r(e){return t.register(e,null===this)}return r.once=e=>{const r=function(...n){e.apply(this,n),t.remove(r)};t.register(r)},r.remove=e=>t.remove(e),r.invoke=(...e)=>t.invoke(...e),r.invokeAsync=(...e)=>t.invokeAsync(...e),r.clear=()=>t.clear(),r},Oe}(),i=te(),o=Ae(),a=K(),c=nr;return X.Room=class l{constructor(e,t){this.onStateChange=s.createSignal(),this.onError=s.createSignal(),this.onLeave=s.createSignal(),this.onJoin=s.createSignal(),this.hasJoined=!1,this.onMessageHandlers=n.createNanoEvents(),this.roomId=null,this.name=e,this.packr=new c.Packr,this.packr.encode(void 0),t&&(this.serializer=new(r.getSerializer("schema")),this.rootSchema=t,this.serializer.state=new t),this.onError((e,t)=>{var r;return null===(r=console.warn)||void 0===r?void 0:r.call(console,`colyseus.js - onError => (${e}) ${t}`)}),this.onLeave(()=>this.removeAllListeners())}connect(t,r,n=this,s,i){const o=new e.Connection(s.protocol);if(n.connection=o,o.events.onmessage=l.prototype.onMessageCallback.bind(n),o.events.onclose=function(e){var t;if(!n.hasJoined)return null===(t=console.warn)||void 0===t||t.call(console,`Room connection was closed unexpectedly (${e.code}): ${e.reason}`),void n.onError.invoke(e.code,e.reason);e.code===a.CloseCode.DEVMODE_RESTART&&r?r():(n.onLeave.invoke(e.code,e.reason),n.destroy())},o.events.onerror=function(e){var t;null===(t=console.warn)||void 0===t||t.call(console,`Room, onError (${e.code}): ${e.reason}`),n.onError.invoke(e.code,e.reason)},"h3"===s.protocol){const e=new URL(t);o.connect(e.origin,s)}else o.connect(t,i)}leave(e=!0){return new Promise(r=>{this.onLeave(e=>r(e)),this.connection?e?(this.packr.buffer[0]=t.Protocol.LEAVE_ROOM,this.connection.send(this.packr.buffer.subarray(0,1))):this.connection.close():this.onLeave.invoke(a.CloseCode.CONSENTED)})}onMessage(e,t){return this.onMessageHandlers.on(this.getMessageHandlerKey(e),t)}send(e,r){const n={offset:1};this.packr.buffer[0]=t.Protocol.ROOM_DATA,"string"==typeof e?i.encode.string(this.packr.buffer,e,n):i.encode.number(this.packr.buffer,e,n),this.packr.position=0;const s=void 0!==r?this.packr.pack(r,2048+n.offset):this.packr.buffer.subarray(0,n.offset);this.connection.send(s)}sendUnreliable(e,r){const n={offset:1};this.packr.buffer[0]=t.Protocol.ROOM_DATA,"string"==typeof e?i.encode.string(this.packr.buffer,e,n):i.encode.number(this.packr.buffer,e,n),this.packr.position=0;const s=void 0!==r?this.packr.pack(r,2048+n.offset):this.packr.buffer.subarray(0,n.offset);this.connection.sendUnreliable(s)}sendBytes(e,r){const n={offset:1};if(this.packr.buffer[0]=t.Protocol.ROOM_DATA_BYTES,"string"==typeof e?i.encode.string(this.packr.buffer,e,n):i.encode.number(this.packr.buffer,e,n),r.byteLength+n.offset>this.packr.buffer.byteLength){const e=new Uint8Array(n.offset+r.byteLength);e.set(this.packr.buffer),this.packr.useBuffer(e)}this.packr.buffer.set(r,n.offset),this.connection.send(this.packr.buffer.subarray(0,n.offset+r.byteLength))}get state(){return this.serializer.getState()}removeAllListeners(){this.onJoin.clear(),this.onStateChange.clear(),this.onError.clear(),this.onLeave.clear(),this.onMessageHandlers.events={},this.serializer instanceof o.SchemaSerializer&&(this.serializer.decoder.root.callbacks={})}onMessageCallback(e){const n=new Uint8Array(e.data),s={offset:1},o=n[0];if(o===t.Protocol.JOIN_ROOM){const e=i.decode.utf8Read(n,s,n[s.offset++]);if(this.serializerId=i.decode.utf8Read(n,s,n[s.offset++]),!this.serializer){const e=r.getSerializer(this.serializerId);this.serializer=new e}n.byteLength>s.offset&&this.serializer.handshake&&this.serializer.handshake(n,s),this.reconnectionToken=`${this.roomId}:${e}`,this.hasJoined=!0,this.onJoin.invoke(),this.packr.buffer[0]=t.Protocol.JOIN_ROOM,this.connection.send(this.packr.buffer.subarray(0,1))}else if(o===t.Protocol.ERROR){const e=i.decode.number(n,s),t=i.decode.string(n,s);this.onError.invoke(e,t)}else if(o===t.Protocol.LEAVE_ROOM)this.leave();else if(o===t.Protocol.ROOM_STATE)this.serializer.setState(n,s),this.onStateChange.invoke(this.serializer.getState());else if(o===t.Protocol.ROOM_STATE_PATCH)this.serializer.patch(n,s),this.onStateChange.invoke(this.serializer.getState());else if(o===t.Protocol.ROOM_DATA){const e=i.decode.stringCheck(n,s)?i.decode.string(n,s):i.decode.number(n,s),t=n.byteLength>s.offset?c.unpack(n,{start:s.offset}):void 0;this.dispatchMessage(e,t)}else if(o===t.Protocol.ROOM_DATA_BYTES){const e=i.decode.stringCheck(n,s)?i.decode.string(n,s):i.decode.number(n,s);this.dispatchMessage(e,n.subarray(s.offset))}}dispatchMessage(e,t){var r;const n=this.getMessageHandlerKey(e);this.onMessageHandlers.events[n]?this.onMessageHandlers.emit(n,t):this.onMessageHandlers.events["*"]?this.onMessageHandlers.emit("*",e,t):null===(r=console.warn)||void 0===r||r.call(console,`colyseus.js: onMessage() not registered for type '${e}'.`)}destroy(){this.serializer&&this.serializer.teardown()}getMessageHandlerKey(e){switch(typeof e){case"string":return e;case"number":return`i${e}`;default:throw new Error("invalid message type.")}}},X}var or={};function ar(e,t){t.headers=e.headers||{},t.statusMessage=e.statusText,t.statusCode=e.status,t.data=e.response}function cr(e,t,r){return new Promise(function(n,s){r=r||{};var i,o,a,c=new XMLHttpRequest,l=r.body,h=r.headers||{};for(i in r.timeout&&(c.timeout=r.timeout),c.ontimeout=c.onerror=function(e){e.timeout="timeout"==e.type,s(e)},c.onabort=function(e){e.aborted=!0,s(e)},c.open(e,t.href||t),c.onload=function(){for(a=c.getAllResponseHeaders().trim().split(/[\r\n]+/),ar(c,c);o=a.shift();)o=o.split(": "),c.headers[o.shift().toLowerCase()]=o.join(": ");if((o=c.headers["content-type"])&&~o.indexOf("application/json"))try{c.data=JSON.parse(c.data,r.reviver)}catch(e){return ar(c,e),s(e)}(c.status>=400?s:n)(c)},typeof FormData<"u"&&l instanceof FormData||l&&"object"==typeof l&&(h["content-type"]="application/json",l=JSON.stringify(l)),c.withCredentials=!!r.withCredentials,h)c.setRequestHeader(i,h[i]);c.send(l),r.signal&&r.signal.addEventListener("abort",function(){c.abort()})})}var lr=cr.bind(cr,"GET"),hr=cr.bind(cr,"POST"),ur=cr.bind(cr,"PATCH"),dr=cr.bind(cr,"DELETE"),fr=cr.bind(cr,"PUT");const pr=n(Object.freeze(Object.defineProperty({__proto__:null,del:dr,get:lr,patch:ur,post:hr,put:fr,send:cr},Symbol.toStringTag,{value:"Module"})));var gr,mr,yr,vr={},br={};function wr(){if(yr)return vr;yr=1;var e,t,r,n,s=H,i=function(){if(mr)return br;mr=1;var e=H;let t;function r(){if(!t)try{t="undefined"!=typeof cc&&cc.sys&&cc.sys.localStorage?cc.sys.localStorage:window.localStorage}catch(e){}return t||void 0===globalThis.indexedDB||(t=new n),t||(t={cache:{},setItem:function(e,t){this.cache[e]=t},getItem:function(e){this.cache[e]},removeItem:function(e){delete this.cache[e]}}),t}class n{constructor(){this.dbPromise=new Promise(e=>{const t=indexedDB.open("_colyseus_storage",1);t.onupgradeneeded=()=>t.result.createObjectStore("store"),t.onsuccess=()=>e(t.result)})}tx(t,r){return e.__awaiter(this,void 0,void 0,function*(){const e=(yield this.dbPromise).transaction("store",t).objectStore("store");return r(e)})}setItem(e,t){return this.tx("readwrite",r=>r.put(t,e)).then()}getItem(t){return e.__awaiter(this,void 0,void 0,function*(){const e=yield this.tx("readonly",e=>e.get(t));return new Promise(t=>{e.onsuccess=()=>t(e.result)})})}removeItem(e){return this.tx("readwrite",t=>t.delete(e)).then()}}return br.getItem=function(e,t){const n=r().getItem(e);"undefined"!=typeof Promise&&n instanceof Promise?n.then(e=>t(e)):t(n)},br.removeItem=function(e){r().removeItem(e)},br.setItem=function(e,t){r().setItem(e,t)},br}(),o=me();return e=new WeakMap,t=new WeakMap,r=new WeakMap,n=new WeakMap,vr.Auth=class{constructor(s){this.http=s,this.settings={path:"/auth",key:"colyseus-auth-token"},e.set(this,!1),t.set(this,void 0),r.set(this,void 0),n.set(this,o.createNanoEvents()),i.getItem(this.settings.key,e=>this.token=e)}set token(e){this.http.authToken=e}get token(){return this.http.authToken}onChange(r){const i=s.__classPrivateFieldGet(this,n,"f").on("change",r);return s.__classPrivateFieldGet(this,e,"f")||s.__classPrivateFieldSet(this,t,new Promise((e,t)=>{this.getUserData().then(e=>{this.emitChange(Object.assign(Object.assign({},e),{token:this.token}))}).catch(e=>{this.emitChange({user:null,token:void 0})}).finally(()=>{e()})}),"f"),s.__classPrivateFieldSet(this,e,!0,"f"),i}getUserData(){return s.__awaiter(this,void 0,void 0,function*(){if(this.token)return(yield this.http.get(`${this.settings.path}/userdata`)).data;throw new Error("missing auth.token")})}registerWithEmailAndPassword(e,t,r){return s.__awaiter(this,void 0,void 0,function*(){const n=(yield this.http.post(`${this.settings.path}/register`,{body:{email:e,password:t,options:r}})).data;return this.emitChange(n),n})}signInWithEmailAndPassword(e,t){return s.__awaiter(this,void 0,void 0,function*(){const r=(yield this.http.post(`${this.settings.path}/login`,{body:{email:e,password:t}})).data;return this.emitChange(r),r})}signInAnonymously(e){return s.__awaiter(this,void 0,void 0,function*(){const t=(yield this.http.post(`${this.settings.path}/anonymous`,{body:{options:e}})).data;return this.emitChange(t),t})}sendPasswordResetEmail(e){return s.__awaiter(this,void 0,void 0,function*(){return(yield this.http.post(`${this.settings.path}/forgot-password`,{body:{email:e}})).data})}signInWithProvider(e){return s.__awaiter(this,arguments,void 0,function*(e,t={}){return new Promise((n,i)=>{const o=t.width||480,a=t.height||768,c=this.token?`?token=${this.token}`:"",l=`Login with ${e[0].toUpperCase()+e.substring(1)}`,h=this.http.client.getHttpEndpoint(`${t.prefix||`${this.settings.path}/provider`}/${e}${c}`),u=screen.width/2-o/2,d=screen.height/2-a/2;s.__classPrivateFieldSet(this,r,window.open(h,l,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+o+", height="+a+", top="+d+", left="+u),"f");const f=e=>{void 0===e.data.user&&void 0===e.data.token||(clearInterval(p),s.__classPrivateFieldGet(this,r,"f").close(),s.__classPrivateFieldSet(this,r,void 0,"f"),window.removeEventListener("message",f),void 0!==e.data.error?i(e.data.error):(n(e.data),this.emitChange(e.data)))},p=setInterval(()=>{s.__classPrivateFieldGet(this,r,"f")&&!s.__classPrivateFieldGet(this,r,"f").closed||(s.__classPrivateFieldSet(this,r,void 0,"f"),i("cancelled"),window.removeEventListener("message",f))},200);window.addEventListener("message",f)})})}signOut(){return s.__awaiter(this,void 0,void 0,function*(){this.emitChange({user:null,token:null})})}emitChange(e){void 0!==e.token&&(this.token=e.token,null===e.token?i.removeItem(this.settings.key):i.setItem(this.settings.key,e.token)),s.__classPrivateFieldGet(this,n,"f").emit("change",e)}},vr}var Er,Or,Ir={};var Ar,Tr,Sr={},_r=(Tr||(Tr=1,function(e){i||(i=1,ArrayBuffer.isView||(ArrayBuffer.isView=e=>null!==e&&"object"==typeof e&&e.buffer instanceof ArrayBuffer),"undefined"==typeof FormData&&(r.FormData=class{}),"undefined"==typeof globalThis&&"undefined"!=typeof window&&(window.globalThis=window));var t=function(){if(Or)return a;Or=1;var e,t=H,r=K(),n=ir(),s=function(){if(gr)return or;gr=1;var e=K();function t(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,Object.freeze(t)}var r=t(pr);return or.HTTP=class{constructor(e,t={}){this.client=e,this.headers=t}get(e,t={}){return this.request("get",e,t)}post(e,t={}){return this.request("post",e,t)}del(e,t={}){return this.request("del",e,t)}put(e,t={}){return this.request("put",e,t)}request(t,n,s={}){return r[t](this.client.getHttpEndpoint(n),this.getOptions(s)).catch(t=>{var r;if(t.aborted)throw new e.AbortError("Request aborted");const n=t.statusCode,s=(null===(r=t.data)||void 0===r?void 0:r.error)||t.statusMessage||t.message;if(!n&&!s)throw t;throw new e.ServerError(n,s)})}getOptions(e){return e.headers=Object.assign({},this.headers,e.headers),this.authToken&&(e.headers.Authorization=`Bearer ${this.authToken}`),"undefined"!=typeof cc&&cc.sys&&cc.sys.isNative||(e.withCredentials=!0),e}},or}(),i=wr(),o=(Er||(Er=1,Ir.discordURLBuilder=function(e){var t;const r=(null===(t=null===window||void 0===window?void 0:window.location)||void 0===t?void 0:t.hostname)||"localhost",n=e.hostname.split("."),s=!e.hostname.includes("trycloudflare.com")&&!e.hostname.includes("discordsays.com")&&n.length>2?`/${n[0]}`:"";return e.pathname.startsWith("/.proxy")?`${e.protocol}//${r}${s}${e.pathname}${e.search}`:`${e.protocol}//${r}/.proxy/colyseus${s}${e.pathname}${e.search}`}),Ir);class c extends Error{constructor(e,t){super(e),this.code=t,this.name="MatchMakeError",Object.setPrototypeOf(this,c.prototype)}}const l="undefined"!=typeof window&&void 0!==(null===(e=null===window||void 0===window?void 0:window.location)||void 0===e?void 0:e.hostname)?`${window.location.protocol.replace("http","ws")}//${window.location.hostname}${window.location.port&&`:${window.location.port}`}`:"ws://127.0.0.1:2567";let h=class{constructor(e=l,t){var r,n;if("string"==typeof e){const t=e.startsWith("/")?new URL(e,l):new URL(e),r="https:"===t.protocol||"wss:"===t.protocol,n=Number(t.port||(r?443:80));this.settings={hostname:t.hostname,pathname:t.pathname,port:n,secure:r,searchParams:t.searchParams.toString()||void 0}}else void 0===e.port&&(e.port=e.secure?443:80),void 0===e.pathname&&(e.pathname=""),this.settings=e;this.settings.pathname.endsWith("/")&&(this.settings.pathname=this.settings.pathname.slice(0,-1)),this.http=new s.HTTP(this,(null==t?void 0:t.headers)||{}),this.auth=new i.Auth(this.http),this.urlBuilder=null==t?void 0:t.urlBuilder,!this.urlBuilder&&"undefined"!=typeof window&&(null===(n=null===(r=null===window||void 0===window?void 0:window.location)||void 0===r?void 0:r.hostname)||void 0===n?void 0:n.includes("discordsays.com"))&&(this.urlBuilder=o.discordURLBuilder,console.log("Colyseus SDK: Discord Embedded SDK detected. Using custom URL builder."))}joinOrCreate(e){return t.__awaiter(this,arguments,void 0,function*(e,t={},r){return yield this.createMatchMakeRequest("joinOrCreate",e,t,r)})}create(e){return t.__awaiter(this,arguments,void 0,function*(e,t={},r){return yield this.createMatchMakeRequest("create",e,t,r)})}join(e){return t.__awaiter(this,arguments,void 0,function*(e,t={},r){return yield this.createMatchMakeRequest("join",e,t,r)})}joinById(e){return t.__awaiter(this,arguments,void 0,function*(e,t={},r){return yield this.createMatchMakeRequest("joinById",e,t,r)})}reconnect(e,r){return t.__awaiter(this,void 0,void 0,function*(){if("string"==typeof e&&"string"==typeof r)throw new Error("DEPRECATED: .reconnect() now only accepts 'reconnectionToken' as argument.\nYou can get this token from previously connected `room.reconnectionToken`");const[t,n]=e.split(":");if(!t||!n)throw new Error("Invalid reconnection token format.\nThe format should be roomId:reconnectionToken");return yield this.createMatchMakeRequest("reconnect",t,{reconnectionToken:n},r)})}consumeSeatReservation(e,n,s){return t.__awaiter(this,void 0,void 0,function*(){const i=this.createRoom(e.room.name,n);i.roomId=e.room.roomId,i.sessionId=e.sessionId;const o={sessionId:i.sessionId};e.reconnectionToken&&(o.reconnectionToken=e.reconnectionToken);const a=s||i;return i.connect(this.buildEndpoint(e.room,o,e.protocol),e.devMode&&(()=>t.__awaiter(this,void 0,void 0,function*(){console.info(`[Colyseus devMode]: ${String.fromCodePoint(128260)} Re-establishing connection with room id '${i.roomId}'...`);let r=0;const s=()=>t.__awaiter(this,void 0,void 0,function*(){r++;try{yield this.consumeSeatReservation(e,n,a),console.info(`[Colyseus devMode]: ${String.fromCodePoint(9989)} Successfully re-established connection with room '${i.roomId}'`)}catch(t){r<8?(console.info(`[Colyseus devMode]: ${String.fromCodePoint(128260)} retrying... (${r} out of 8)`),setTimeout(s,2e3)):console.info(`[Colyseus devMode]: ${String.fromCodePoint(10060)} Failed to reconnect. Is your server running? Please check server logs.`)}});setTimeout(s,2e3)})),a,e,this.http.headers),new Promise((e,t)=>{const n=(e,n)=>t(new r.ServerError(e,n));a.onError.once(n),a.onJoin.once(()=>{a.onError.remove(n),e(a)})})})}createMatchMakeRequest(e,r){return t.__awaiter(this,arguments,void 0,function*(e,t,r={},n,s){const i=(yield this.http.post(`matchmake/${e}/${t}`,{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(r)})).data;if(i.error)throw new c(i.error,i.code);return"reconnect"===e&&(i.reconnectionToken=r.reconnectionToken),yield this.consumeSeatReservation(i,n,s)})}createRoom(e,t){return new n.Room(e,t)}buildEndpoint(e,t={},r="ws"){let n=this.settings.searchParams||"";this.http.authToken&&(t._authToken=this.http.authToken);for(const o in t)t.hasOwnProperty(o)&&(n+=(n?"&":"")+`${o}=${t[o]}`);"h3"===r&&(r="http");let s=this.settings.secure?`${r}s://`:`${r}://`;e.publicAddress?s+=`${e.publicAddress}`:s+=`${this.settings.hostname}${this.getEndpointPort()}${this.settings.pathname}`;const i=`${s}/${e.processId}/${e.roomId}?${n}`;return this.urlBuilder?this.urlBuilder(new URL(i)):i}getHttpEndpoint(e=""){const t=e.startsWith("/")?e:`/${e}`;let r=`${this.settings.secure?"https":"http"}://${this.settings.hostname}${this.getEndpointPort()}${this.settings.pathname}${t}`;return this.settings.searchParams&&(r+=`?${this.settings.searchParams}`),this.urlBuilder?this.urlBuilder(new URL(r)):r}getEndpointPort(){return 80!==this.settings.port&&443!==this.settings.port?`:${this.settings.port}`:""}};return h.VERSION="0.16.19",a.Client=h,a.MatchMakeError=c,a}(),n=he(),s=ir(),o=wr(),c=K(),l=Ae(),h=(Ar||(Ar=1,Sr.NoneSerializer=class{setState(e){}getState(){return null}patch(e){}teardown(){}handshake(e){}}),Sr),u=fe();u.registerSerializer("schema",l.SchemaSerializer),u.registerSerializer("none",h.NoneSerializer),e.Client=t.Client,e.MatchMakeError=t.MatchMakeError,Object.defineProperty(e,"ErrorCode",{enumerable:!0,get:function(){return n.ErrorCode}}),Object.defineProperty(e,"Protocol",{enumerable:!0,get:function(){return n.Protocol}}),e.Room=s.Room,e.Auth=o.Auth,e.ServerError=c.ServerError,e.SchemaSerializer=l.SchemaSerializer,e.getStateCallbacks=l.getStateCallbacks,e.registerSerializer=u.registerSerializer}(o)),o),xr=s();class Cr extends xr.Scene{constructor(){super("Boot")}preload(){this.load.image("background","assets/bg.png")}create(){this.scene.start("Preloader")}}class Pr extends xr.Scene{constructor(){super("GameOver"),t(this,"camera"),t(this,"background"),t(this,"gameover_text")}create(){this.camera=this.cameras.main,this.camera.setBackgroundColor(16711680),this.background=this.add.image(512,384,"background"),this.background.setAlpha(.5),this.gameover_text=this.add.text(512,384,"Game Over",{fontFamily:"Arial Black",fontSize:64,color:"#ffffff",stroke:"#000000",strokeThickness:8,align:"center"}),this.gameover_text.setOrigin(.5),this.input.once("pointerdown",()=>{this.scene.start("MainMenu")})}}function Rr(e,t){const r=[];for(let n=0;n<e.length;n+=t)r.push(e.slice(n,n+t));return r}function kr(e,t){return{x:e%t,y:Math.floor(e/t)}}class Dr extends xr.Scene{constructor(){super("Game"),t(this,"camera"),t(this,"playerContainer"),t(this,"playerSprite"),t(this,"cursors"),t(this,"wasd"),t(this,"map"),t(this,"players",new Map),t(this,"cursor"),t(this,"ground")}createPlayer(e,t,r){const n=Lr.getPlayerState(t),s=this.add.sprite(0,0,"player",0).setOrigin(.5),i=this.add.text(0,-30,n.username,{fontSize:"14px",color:"#ffffff",stroke:"#000000",strokeThickness:3,backgroundColor:"#00000035"}).setOrigin(.5,0),o=this.add.container(n.x,n.y,[s,i]);this.physics.add.existing(o),o.body.setCollideWorldBounds(!0),o.body.setSize(s.width,s.height),o.body.setCircle(10,-10,-10);const a={container:o,sprite:s};return e||(Lr.$(r).listen("x",e=>{o.x=e}),Lr.$(r).listen("y",e=>{o.y=e})),this.players.set(t,a),Lr.$(r).areas.onAdd(e=>{Lr.$(e).cells.onAdd((e,t)=>{const n=kr(e,this.map.width);this.ground.setTint(r.color,n.x,n.y,1,1)}),Lr.$(e).cells.onRemove((e,t)=>{const r=kr(e,this.map.width);this.ground.setTint(16777215,r.x,r.y,1,1)})}),a}create(){const e=Lr.room.state;this.camera=this.cameras.main,this.camera.setBackgroundColor(0);const t=this.make.tilemap({tileWidth:32,tileHeight:32,width:e.width,height:e.height});this.map=t;const r=t.addTilesetImage("tilemap"),n=t.createBlankLayer("ground",r,0,0);this.ground=n;const s=t.createBlankLayer("buildings",r,0,0);n.setCollision([0,3]),this.physics.world.setBounds(0,0,t.widthInPixels,t.heightInPixels),this.camera.setBounds(0,0,t.widthInPixels,t.heightInPixels,!0);const i=this.createPlayer(!0,Lr.room.sessionId,Lr.getPlayerState());this.playerContainer=i.container,this.playerSprite=i.sprite,this.physics.add.collider(this.playerContainer,n),this.anims.create({key:"down",frames:this.anims.generateFrameNumbers("player",{start:0,end:0}),frameRate:10,repeat:-1}),this.anims.create({key:"left",frames:this.anims.generateFrameNumbers("player",{start:1,end:1}),frameRate:10,repeat:-1}),this.anims.create({key:"right",frames:this.anims.generateFrameNumbers("player",{start:2,end:2}),frameRate:10,repeat:-1}),this.anims.create({key:"up",frames:this.anims.generateFrameNumbers("player",{start:3,end:3}),frameRate:10,repeat:-1}),this.cursors=this.input.keyboard.createCursorKeys(),this.wasd={up:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W),down:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S),left:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),right:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D)},this.cameras.main.startFollow(this.playerContainer,!0,.1,.1),this.input.on("wheel",(e,t,r,n)=>{const s=this.cameras.main.zoom-.001*n;this.cameras.main.setZoom(Phaser.Math.Clamp(s,.4,2))}),this.input.on("pointerdown",r=>{var n;const s=r.positionToCamera(this.cameras.main),i=(o=t.worldToTileX(s.x),a=t.worldToTileY(s.y),c=e.width,a*c+o);var o,a,c;null==(n=Lr.room)||n.send("place_tile",{index:i})});const o=e.map.toJSON(),a=e.buildings.toJSON();n.putTilesAt(Rr(o,e.width),0,0),s.putTilesAt(Rr(a,e.width),0,0),Lr.$(e).map.onChange((t,r)=>{const s=kr(r,e.width);n.putTileAt(t,s.x,s.y)}),Lr.$(e).buildings.onChange((t,r)=>{const n=kr(r,e.width);s.putTileAt(t,n.x,n.y)}),Lr.$(e).players.onAdd((e,t)=>{t==Lr.room.sessionId||this.players.has(t)||this.createPlayer(!1,t,e)}),Lr.$(e).players.onRemove((e,t)=>{this.players.get(t).container.destroy()}),this.scene.launch("HudScene",{gameScene:this}),this.cursor=this.add.sprite(0,0,"cursor").setOrigin(0,0)}update(){var e,t,r,n,s;const i=new Phaser.Math.Vector2(0,0);(null==(e=this.cursors.left)?void 0:e.isDown)||this.wasd.left.isDown?i.x=-1:((null==(t=this.cursors.right)?void 0:t.isDown)||this.wasd.right.isDown)&&(i.x=1),(null==(r=this.cursors.up)?void 0:r.isDown)||this.wasd.up.isDown?i.y=-1:((null==(n=this.cursors.down)?void 0:n.isDown)||this.wasd.down.isDown)&&(i.y=1),i.normalize().scale(150),this.playerContainer.body.setVelocity(i.x,i.y),i.x<0?this.playerSprite.anims.play("left",!0):i.x>0?this.playerSprite.anims.play("right",!0):i.y<0?this.playerSprite.anims.play("up",!0):i.y>0?this.playerSprite.anims.play("down",!0):this.playerSprite.anims.stop(),i.length()>0&&(null==(s=Lr.room)||s.send("pos",{x:this.playerContainer.x,y:this.playerContainer.y})),this.playerContainer.x=Math.round(this.playerContainer.x),this.playerContainer.y=Math.round(this.playerContainer.y);const o=this.input.activePointer.positionToCamera(this.cameras.main),a=this.map,c=a.worldToTileX(o.x),l=a.worldToTileY(o.y),h=a.tileToWorldX(c),u=a.tileToWorldY(l);this.cursor.setPosition(h,u)}}class Nr extends Phaser.Scene{constructor(){super("HudScene"),t(this,"minimapRT"),t(this,"playerMarkers",new Map),t(this,"gameScene")}create(e){this.gameScene=e.gameScene;const t=Lr.room.state,r=t.width,n=t.height,s={0:3167869,1:4091034,2:16777215,3:11709098,4:11709098,5:4902723};this.minimapRT=this.add.renderTexture(0,0,r,n).setOrigin(0,0).setScrollFactor(0).setDepth(1e3).setScale(3),this.positionMinimap();const i=t.map.toJSON();for(let o=0;o<n;o++)for(let e=0;e<r;e++){const t=i[e+o*r];this.minimapRT.fill(s[t]??16777215,1,e,o,1,1)}t.players.forEach((e,t)=>{this.addPlayerMarker(t)}),Lr.$(t).players.onAdd((e,t)=>{this.addPlayerMarker(t)}),Lr.$(t).players.onRemove((e,t)=>{const r=this.playerMarkers.get(t);r&&r.destroy(),this.playerMarkers.delete(t)}),Lr.$(t).map.onChange((e,t)=>{const n=t%r,i=Math.floor(t/r);this.minimapRT.fill(s[e]??16777215,1,n,i,1,1)})}update(){this.gameScene&&Lr.room.state.players.forEach((e,t)=>{const r=this.playerMarkers.get(t);if(!r)return;const n=e.x/32,s=e.y/32;r.x=this.minimapRT.x+n*this.minimapRT.scaleX,r.y=this.minimapRT.y+s*this.minimapRT.scaleY})}positionMinimap(){this.minimapRT.setScale(3),this.minimapRT.x=this.scale.width-this.minimapRT.width*this.minimapRT.scaleX-10,this.minimapRT.y=10}addPlayerMarker(e){var t;const r=e===(null==(t=Lr.room)?void 0:t.sessionId)?16711680:255,n=this.add.graphics().setDepth(1001);n.lineStyle(1,0,1),n.fillStyle(r,1),n.fillCircle(0,0,3),n.strokeCircle(0,0,3),this.playerMarkers.set(e,n)}}class $r extends xr.Scene{constructor(){super("MainMenu"),t(this,"background"),t(this,"logo"),t(this,"title")}async create(){this.background=this.add.image(512,384,"background"),this.logo=this.add.image(512,300,"logo"),this.title=this.add.text(512,460,"连接服务器中...",{fontFamily:"Arial Black",fontSize:18,color:"#00000",align:"center"}).setOrigin(.5);try{await Lr.join(),this.scene.start("Game")}catch(Br){console.log("失败"),this.title.text="连接失败"}}}class Mr extends xr.Scene{constructor(){super("Preloader")}init(){this.add.image(512,384,"background"),this.add.rectangle(512,384,468,32).setStrokeStyle(1,16777215);const e=this.add.rectangle(282,384,4,28,16777215);this.load.on("progress",t=>{e.width=4+460*t})}preload(){this.load.setPath("assets"),this.load.image("logo","logo.png"),this.load.image("tilemap","tilemap.png"),this.load.image("cursor","cursor.png"),this.load.spritesheet("player","player.png",{frameWidth:32,frameHeight:32})}create(){this.scene.start("MainMenu")}}const jr={type:xr.AUTO,width:1024,height:768,parent:"game-container",backgroundColor:"#028af8",pixelArt:!0,scale:{mode:xr.Scale.EXPAND},scene:[Cr,Mr,$r,Dr,Pr,Nr],physics:{default:"arcade"}},Lr=new class{constructor(){t(this,"client"),t(this,"room"),t(this,"$"),this.client=new _r.Client("ws://43.133.1.198/api")}async join(){const e=this.client,t="无名氏"+Math.round(100*Math.random()),r=await e.joinOrCreate("room",{username:t});this.room=r,console.log("joined successfully",r.state),this.$=_r.getStateCallbacks(this.room),await new Promise(e=>{r.onStateChange.once(()=>e())})}getPlayerState(e){return this.room.state.players.get(e??this.room.sessionId)}};document.addEventListener("DOMContentLoaded",async()=>{new xr.Game({...jr,parent:"game-container"})});
